{
  "active": true,
  "connections": {
    "Cal Trigger": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca MSR": {
      "main": [
        [
          {
            "node": "Busca o pedido de acolhimento com status de encaminhamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca MSR1": {
      "main": [
        [
          {
            "node": "Busca o pedido de acolhimento com status de agendado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Slack - Reagendamento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Slack - Cancelamento",
            "type": "main",
            "index": 0
          },
          {
            "node": "Busca MSR1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Busca MSR",
            "type": "main",
            "index": 0
          },
          {
            "node": "Slack - Novo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca o pedido de acolhimento com status de agendado": {
      "main": [
        [
          {
            "node": "Atualiza status pedido de acolhimento para encaminhado",
            "type": "main",
            "index": 0
          },
          {
            "node": "Atualiza status do acolhimento para encaminhado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca o pedido de acolhimento com status de encaminhamento": {
      "main": [
        [
          {
            "node": "Atualiza status pedido de acolhimento para agendado",
            "type": "main",
            "index": 0
          },
          {
            "node": "Atualiza status do acolhimento para agendado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2024-03-18T21:17:45.868Z",
  "id": "gRJx0R8RjbMq6VmF",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "[Notificação] Agendamentos Cal",
  "nodes": [
    {
      "parameters": {
        "events": [
          "BOOKING_CREATED",
          "BOOKING_RESCHEDULED",
          "BOOKING_CANCELLED"
        ],
        "options": {}
      },
      "id": "4b99f73f-840c-4a54-bd28-82791611e640",
      "name": "Cal Trigger",
      "type": "n8n-nodes-base.calTrigger",
      "typeVersion": 2,
      "position": [
        -140,
        280
      ],
      "webhookId": "577771d1-a071-4c89-b718-a4212f5b149d",
      "credentials": {
        "calApi": {
          "id": "lRoj2fcPQhQG4AQf",
          "name": "Cal account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "#alertas-tech-provisao",
          "mode": "name"
        },
        "text": "=:calendar: :repeat: {{ $json.attendees[0].name }} ({{ $json.attendees[0].email }}) reagendou o atendimento para o dia {{ new Date($json.startTime).toLocaleDateString(\"pt-BR\") }}.",
        "otherOptions": {
          "includeLinkToWorkflow": false,
          "botProfile": {
            "imageValues": {
              "profilePhotoType": "emoji",
              "icon_emoji": "🤖"
            }
          },
          "link_names": false
        }
      },
      "id": "d7b6e19f-05c3-4560-9d78-6c9898bde1d1",
      "name": "Slack - Reagendamento",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        1080,
        -80
      ],
      "credentials": {
        "slackOAuth2Api": {
          "id": "01G85hUbLT4VlY92",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "#alertas-tech-provisao",
          "mode": "name"
        },
        "text": "=:calendar: :x: {{ $json.attendees[0].name }} ({{ $json.attendees[0].email }}) cancelou o atendimento do dia {{ new Date($json.startTime).toLocaleDateString(\"pt-BR\") }}. {{ $json.cancellationReason ? `Adicionou o seguinte motivo: ${$json.cancellationReason}` : 'Não adicionou o motivo.' }}.",
        "otherOptions": {
          "includeLinkToWorkflow": false,
          "botProfile": {
            "imageValues": {
              "profilePhotoType": "emoji",
              "icon_emoji": "🤖"
            }
          }
        }
      },
      "id": "17fbd01d-2132-4d81-800c-0f55b7b2f1ac",
      "name": "Slack - Cancelamento",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        1000,
        280
      ],
      "credentials": {
        "slackOAuth2Api": {
          "id": "01G85hUbLT4VlY92",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "resource": "user",
        "operation": "search",
        "filters": {
          "query": "={{ $json.responses.email.value }}"
        }
      },
      "id": "cede8f6d-9012-4bdd-893c-c322f73643ca",
      "name": "Busca MSR",
      "type": "n8n-nodes-base.zendesk",
      "typeVersion": 1,
      "position": [
        680,
        700
      ],
      "credentials": {
        "zendeskApi": {
          "id": "MYAFeR51noxrxEC7",
          "name": "Zendesk account"
        }
      }
    },
    {
      "parameters": {
        "resource": "user",
        "operation": "search",
        "filters": {
          "query": "={{ $json.responses.email.value }}"
        }
      },
      "id": "a690cd9b-c054-4527-b5fa-d3a5445c8206",
      "name": "Busca MSR1",
      "type": "n8n-nodes-base.zendesk",
      "typeVersion": 1,
      "position": [
        1240,
        440
      ],
      "credentials": {
        "zendeskApi": {
          "id": "MYAFeR51noxrxEC7",
          "name": "Zendesk account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.triggerEvent }}",
                    "rightValue": "BOOKING_RESCHEDULED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Reagendado"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "363b3af0-e486-4ac1-854d-9ea8ae023a84",
                    "leftValue": "={{ $json.triggerEvent }}",
                    "rightValue": "BOOKING_CANCELLED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancelado"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "77dcf11d-eaa1-4021-8ea4-140e64d634ad",
                    "leftValue": "={{ $json.triggerEvent }}",
                    "rightValue": "BOOKING_CREATED",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Agendamento criado"
            }
          ]
        },
        "options": {}
      },
      "id": "d2226223-bcb5-4de7-94b0-9225a7bb6e82",
      "name": "Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        220,
        280
      ]
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "#alertas-tech-provisao",
          "mode": "name"
        },
        "text": "=:calendar: {{ $json.attendees[0].name }} ({{ $json.attendees[0].email }}) agendou um atendimento para o dia {{ new Date($json.startTime).toLocaleDateString(\"pt-BR\") }}.",
        "otherOptions": {
          "includeLinkToWorkflow": false,
          "botProfile": {
            "imageValues": {
              "profilePhotoType": "emoji",
              "icon_emoji": "🤖"
            }
          }
        }
      },
      "id": "b95ec24e-f3e6-43a2-ab9f-9b8f5310b2e0",
      "name": "Slack - Novo",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        620,
        520
      ],
      "credentials": {
        "slackOAuth2Api": {
          "id": "01G85hUbLT4VlY92",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "id": "={{ $json.zendesk_ticket_id }}",
        "updateFields": {
          "customFieldsUi": {
            "customFieldsValues": [
              {
                "id": 360014379412,
                "value": "Assistente Social: Agendado"
              }
            ]
          }
        }
      },
      "id": "499e25c3-dc89-4557-a2a8-4b51ea3efc26",
      "name": "Atualiza status do acolhimento para agendado",
      "type": "n8n-nodes-base.zendesk",
      "typeVersion": 1,
      "position": [
        1280,
        660
      ],
      "credentials": {
        "zendeskApi": {
          "id": "MYAFeR51noxrxEC7",
          "name": "Zendesk account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE \"match\".support_requests set status = 'scheduled_social_worker', updated_at = NOW()  WHERE support_request_id = {{ $json.support_request_id }};\n\nINSERT INTO \"match\".support_request_status_history\n(support_request_id, status, created_at)\nVALUES( {{ $json.support_request_id }}, 'scheduled_social_worker', CURRENT_TIMESTAMP);",
        "options": {}
      },
      "id": "307669e5-1a6c-4990-9ff6-404c97210762",
      "name": "Atualiza status pedido de acolhimento para agendado",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        1300,
        900
      ],
      "credentials": {
        "postgres": {
          "id": "lveNjRL3anzREWd8",
          "name": "[STG] Mapa"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "id": "={{ $json.zendesk_ticket_id }}",
        "updateFields": {
          "customFieldsUi": {
            "customFieldsValues": [
              {
                "id": 360014379412,
                "value": "Encaminhamento: Assistente Social"
              }
            ]
          }
        }
      },
      "id": "9c327e04-93fb-46c9-bb96-2f17236512d2",
      "name": "Atualiza status do acolhimento para encaminhado",
      "type": "n8n-nodes-base.zendesk",
      "typeVersion": 1,
      "position": [
        1900,
        280
      ],
      "credentials": {
        "zendeskApi": {
          "id": "MYAFeR51noxrxEC7",
          "name": "Zendesk account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE \"match\".support_requests set status = 'social_worker',  updated_at = NOW()  WHERE support_request_id = {{ $json.support_request_id }};\n\nINSERT INTO \"match\".support_request_status_history\n(support_request_id, status, created_at)\nVALUES( {{ $json.support_request_id }}, 'social_worker', CURRENT_TIMESTAMP);",
        "options": {}
      },
      "id": "7eea6773-c956-4995-905b-cc64a36439a1",
      "name": "Atualiza status pedido de acolhimento para encaminhado",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        1940,
        480
      ],
      "credentials": {
        "postgres": {
          "id": "lveNjRL3anzREWd8",
          "name": "[STG] Mapa"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "\nselect * from \"match\".support_requests sr where status  = 'scheduled_social_worker' and msr_id  = {{ $json.id }}",
        "options": {}
      },
      "id": "a2582413-2f3e-4aa3-b72d-742423695978",
      "name": "Busca o pedido de acolhimento com status de agendado",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        1560,
        340
      ],
      "credentials": {
        "postgres": {
          "id": "lveNjRL3anzREWd8",
          "name": "[STG] Mapa"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "\nselect * from \"match\".support_requests sr where status  = 'social_worker' and msr_id  = {{ $json.id }}",
        "options": {}
      },
      "id": "fe5359ac-433b-4bcc-87a8-08cf774035ce",
      "name": "Busca o pedido de acolhimento com status de encaminhamento",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        940,
        700
      ],
      "credentials": {
        "postgres": {
          "id": "lveNjRL3anzREWd8",
          "name": "[STG] Mapa"
        }
      }
    }
  ],
  "pinData": {
    "Cal Trigger": [
      {
        "json": {
          "triggerEvent": "BOOKING_CANCELLED",
          "createdAt": "2024-04-03T00:44:38.445Z",
          "bookerUrl": "https://cal.com",
          "type": "assistente-social",
          "title": "Atendimento com Assistente Social entre Thalita e Anne Luaryel ",
          "description": "➡️ ****Como funciona?****\n\nPara que possa passar por uma ****atendimento social remoto**** com a assistente social indicada, ****selecione aqui o melhor dia e horário para seu atendimento.****\n\n<p><br></p>\n\nAo selecionar, o agendamento será confirmado e você receberá uma notificação no seu e-mail ****com o horário, dia e link do Google Meet para a realização do atendimento.****\n\n<p><br></p>\n\nCom isso, basta aguardar o dia do encontro chegar e entrar na sala do Google Meet! Nossa assistente social estará te esperando lá!\n\n<p><br></p>\n\nA profissional te fará algumas perguntas relacionadas à renda, escolaridade, situação de violência vivenciada, entre outras questões, para que ****depois desse atendimento****, possamos te oferecer a orientação mais adequada ao seu caso.\n\n<p><br></p>\n\n➡️ ****O que acontece depois do atendimento social?****\n\nApós análise técnica realizada pela assistente social, você será encaminhada para o serviço público de proteção às mulheres da sua região que possa atender, apropriadamente, a sua demanda. A assistente social te oferecerá todas as informações e orientações necessárias para que tenha a ajuda que precisa! Não se preocupe <3<br>\n\n****(!)**** Caso tenha alguma dúvida sobre esse processo ou não possa comparecer no atendimento agendado e precise remarcar, ****basta entrar em contato conosco no e-mail:**** [****atendimento@mapadoacolhimento.org****](mailto:atendimento@mapadoacolhimento.org)****.**** Te retornaremos por lá com as orientações necessárias!",
          "additionalNotes": "",
          "customInputs": {},
          "startTime": "2024-04-10T19:00:00Z",
          "endTime": "2024-04-10T21:00:00Z",
          "organizer": {
            "id": 676006,
            "name": "Thalita",
            "email": "atendimento@mapadoacolhimento.org",
            "username": "mapa-do-acolhimento",
            "timeZone": "America/Sao_Paulo",
            "language": {
              "locale": "pt-BR"
            },
            "timeFormat": "HH:mm",
            "utcOffset": -180
          },
          "responses": {
            "name": {
              "label": "your_name",
              "value": "MSR Dev Teste ",
              "isHidden": false
            },
            "email": {
              "label": "email_address",
              "value": "msr.dev.mapa@gmail.com",
              "isHidden": false
            },
            "location": {
              "label": "location",
              "value": {
                "optionValue": "",
                "value": "integrations:google:meet"
              },
              "isHidden": false
            },
            "title": {
              "label": "what_is_this_meeting_about",
              "isHidden": true
            },
            "notes": {
              "label": "additional_notes",
              "isHidden": true
            },
            "guests": {
              "label": "additional_guests",
              "value": [],
              "isHidden": true
            },
            "rescheduleReason": {
              "label": "reason_for_reschedule",
              "isHidden": true
            }
          },
          "userFieldsResponses": {
            "title": {
              "label": "what_is_this_meeting_about",
              "isHidden": true
            }
          },
          "attendees": [
            {
              "email": "msr.dev.mapa@gmail.com",
              "name": "MSR dev Teste",
              "firstName": "",
              "lastName": "",
              "timeZone": "America/Sao_Paulo",
              "language": {
                "locale": "pt-BR"
              },
              "utcOffset": -180
            }
          ],
          "location": "integrations:google:meet",
          "destinationCalendar": [
            {
              "id": 196787,
              "integration": "google_calendar",
              "externalId": "thalita@mapa.org.br",
              "primaryEmail": null,
              "userId": null,
              "eventTypeId": 616028,
              "credentialId": 298084
            }
          ],
          "hideCalendarNotes": false,
          "requiresConfirmation": false,
          "eventTypeId": 616028,
          "seatsShowAttendees": true,
          "seatsPerTimeSlot": null,
          "seatsShowAvailabilityCount": true,
          "schedulingType": null,
          "iCalUID": "1axHAdLewLV7gsAv2HdMTp@Cal.com",
          "iCalSequence": 0,
          "uid": "1axHAdLewLV7gsAv2HdMTp",
          "conferenceData": {
            "createRequest": {
              "requestId": "8a0ce172-f69a-51b5-8481-93feb73d58e2"
            }
          },
          "appsStatus": [
            {
              "appName": "google-calendar",
              "type": "google_calendar",
              "success": 1,
              "failures": 0,
              "errors": [],
              "warnings": []
            },
            {
              "appName": "Google Meet",
              "type": "conferencing",
              "success": 1,
              "failures": 0,
              "errors": []
            }
          ],
          "eventTitle": "Atendimento com Assistente Social",
          "eventDescription": "➡️ ****Como funciona?****\n\nPara que possa passar por uma ****atendimento social remoto**** com a assistente social indicada, ****selecione aqui o melhor dia e horário para seu atendimento.****\n\n<p><br></p>\n\nAo selecionar, o agendamento será confirmado e você receberá uma notificação no seu e-mail ****com o horário, dia e link do Google Meet para a realização do atendimento.****\n\n<p><br></p>\n\nCom isso, basta aguardar o dia do encontro chegar e entrar na sala do Google Meet! Nossa assistente social estará te esperando lá!\n\n<p><br></p>\n\nA profissional te fará algumas perguntas relacionadas à renda, escolaridade, situação de violência vivenciada, entre outras questões, para que ****depois desse atendimento****, possamos te oferecer a orientação mais adequada ao seu caso.\n\n<p><br></p>\n\n➡️ ****O que acontece depois do atendimento social?****\n\nApós análise técnica realizada pela assistente social, você será encaminhada para o serviço público de proteção às mulheres da sua região que possa atender, apropriadamente, a sua demanda. A assistente social te oferecerá todas as informações e orientações necessárias para que tenha a ajuda que precisa! Não se preocupe <3<br>\n\n****(!)**** Caso tenha alguma dúvida sobre esse processo ou não possa comparecer no atendimento agendado e precise remarcar, ****basta entrar em contato conosco no e-mail:**** [****atendimento@mapadoacolhimento.org****](mailto:atendimento@mapadoacolhimento.org)****.**** Te retornaremos por lá com as orientações necessárias!",
          "price": 0,
          "currency": "usd",
          "length": 120,
          "bookingId": 1671110,
          "metadata": {
            "videoCallUrl": "https://meet.google.com/dzu-booc-mqu"
          },
          "status": "ACCEPTED"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "HYstwqyTrzYsvJ2P"
  },
  "staticData": {
    "node:Cal Trigger": {
      "webhookId": "ad8da5c2-2975-4028-9ea1-2d6006f4672f"
    }
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2024-04-17T19:19:33.000Z",
  "versionId": "eae52b61-1e91-4c88-b5f6-2c8e51800011"
}