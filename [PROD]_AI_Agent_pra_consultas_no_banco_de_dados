{
  "active": true,
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "DB Schema": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Run SQL Query": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Run SQL Query1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "DB Schema1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-02-04T19:57:24.853Z",
  "id": "uE1tYxILaoI1yyCg",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "[PROD] AI Agent pra consultas no banco de dados",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "id": "0d681a5c-9970-4273-bb9c-83f9e6fd47a5",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        780,
        580
      ],
      "typeVersion": 1,
      "credentials": {
        "openAiApi": {
          "id": "oXPQUooT35CwTcvu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Run custom SQL queries using knowledge about Output structure to provide needed response for user request.\nUse ->> operator to extract JSON data.",
        "operation": "executeQuery",
        "query": "{{ $fromAI(\"query\",\"SQL query for PostgreSQL DB\") }}",
        "options": {}
      },
      "id": "2904b679-f70d-482d-b2f4-8913217b359f",
      "name": "Run SQL Query",
      "type": "n8n-nodes-base.postgresTool",
      "position": [
        1100,
        580
      ],
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "c5mNsjWNXx3mw1Fh",
          "name": "[PROD] Mapa"
        }
      }
    },
    {
      "parameters": {
        "name": "db_schema",
        "description": "Call this tool to get a description of the DB Schema",
        "jsCode": "const dbSchema = [\n    {\n        table_name: \"msr.msrs\",\n        table_description: \"Essa tabela contém as informações das MSRs (Mulher em Situação de Risco) atendidas pelo Mapa do Acolhimento. Essa tabela contém informações que não são PII.\",\n        table_columns: [\n            {\n                column_name: \"msr_id\",\n                column_type: \"BIGINT\",\n                column_description: \"ID único da MSR. Também corresponde ao user ID do Zendesk.\"\n            },\n            {\n                column_name: \"gender\",\n                column_type: \"ENUM\",\n                column_description: \"Gênero da MSR. As opções são: cis_woman (mulher cis), trans_woman (mulher trans) e not_found (informação não disponível).\"\n            },\n            {\n                column_name: \"race_color\",\n                column_type: \"ENUM\",\n                column_description: \"Raça e/ou cor da MSR. As opções são black (preta), brown (parda), indigenous (indígena), white (branca), yellow (amarela), not_found (informação não disponível).\"\n            },\n            {\n                column_name: \"has_disability\",\n                column_type: \"BOOL\",\n                column_description: \"Indica se a MSR tem deficiência. Pode ser nulo, caso essa informação não esteja disponível.\"\n            },\n            {\n                column_name: \"accepts_online_support\",\n                column_type: \"BOOL\",\n                column_description: \"Indica se a MSR aceita receber atendimento online.\"\n            },\n            {\n                column_name: \"zipcode\",\n                column_type: \"VARCHAR\",\n                column_description: \"Zipcode (ou CEP, no Brasil) da MSR.\"\n            },\n            {\n                column_name: \"neighborhood\",\n                column_type: \"VARCHAR\",\n                column_description: \"Bairro da MSR.\"\n            },\n            {\n                column_name: \"city\",\n                column_type: \"VARCHAR\",\n                column_description: \"Cidade da MSR. Todos os valores estão em upper case e sem caracteres especiais.\"\n            },\n            {\n                column_name: \"state\",\n                column_type: \"VARCHAR\",\n                column_description: \"Sigla do Estado da MSR.\"\n            },\n            {\n                column_name: \"status\",\n                column_type: \"ENUM\",\n                column_description: \"Status atual da MSR. As opções são `registered` (cadastrada) e `unregistered` (descadastrada).\"\n            },\n            {\n                column_name: \"created_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp de cadastro da MSR.\"\n            },\n            {\n                column_name: \"updated_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp da última atualização da linha.\"\n            }\n        ]\n    },\n    {\n        table_name: \"msr.msr_status_history\",\n        table_description: \"Essa tabela contém o histórico de status das MSRs (Mulher em Situação de Risco) atendidas pelo Mapa do Acolhimento.\",\n        table_columns: [\n            {\n                column_name: \"msr_status_history_id\",\n                column_type: \"INT\",\n                column_description: \"ID único da tabela.\"\n            },\n            {\n                column_name: \"msr_id\",\n                column_type: \"BIGINT\",\n                column_description: \"ID único da MSR. Também corresponde ao user ID do Zendesk.\"\n            },\n            {\n                column_name: \"status\",\n                column_type: \"ENUM\",\n                column_description: \"Status atual da MSR. As opções são `registered` (cadastrada) e `unregistered` (descadastrada)\"\n            },\n            {\n                column_name: \"created_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp de criação desse status.\"\n            },\n        ]\n    },\n    {\n        table_name: \"match.support_request\",\n        table_description: \"Essa tabela contém as informações dos Pedidos de Acolhimento recebidos pelo Mapa do Acolhimento. Cada Pedido de Acolhimento é realizado por uma MSR (Mulher em Situação de Risco) quando ela se cadastra em nossa plataforma.\",\n        table_columns: [\n            {\n                column_name: \"support_request_id\",\n                column_type: \"INT\",\n                column_description: \"ID único do Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"msr_id\",\n                column_type: \"BIGINT\",\n                column_description: \"ID da MSR que realizou o Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"zendesk_ticket_id\",\n                column_type: \"INT\",\n                column_description: \"ID do ticket do Zendesk que corresponde ao Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"support_type\",\n                column_type: \"ENUM\",\n                column_description: \"Tipo de Acolhimento. As opções são `legal` (jurídico) e `psychological` (psicológico).\"\n            },\n            {\n                column_name: \"lat\",\n                column_type: \"DECIMAL\",\n                column_description: \"Latitude da MSR que realizou o Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"lng\",\n                column_type: \"DECIMAL\",\n                column_description: \"Longitude da MSR que realizou o Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"city\",\n                column_type: \"VARCHAR\",\n                column_description: \"Cidade da MSR que realizou o Pedido de Acolhimento. Todos os valores estão em upper case e sem caracteres especiais.\"\n            },\n            {\n                column_name: \"state\",\n                column_type: \"VARCHAR\",\n                column_description: \"Sigla do Estado da MSR que realizou o Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"status\",\n                column_type: \"ENUM\",\n                column_description: \"Status atual do Pedido de Acolhimento. As opções são `open` (solicitação recebida),  `matched` (match com uma Voluntária),  `social_worker` (encaminhado para a Assistente Social), `public_service` (encaminhado para Serviço Público), `duplicated` (solicitação repetida), `closed` (solicitação encerrada), `public_service_with_social_worker` (encaminhado para Serviço Público através da Assistente Social), `scheduled_social_worker` (entrevista com a Assistente Social agendada), `expired_social_worker` (entrevista com a Assistente Social com prazo expirado), `waiting_for_match` (aguardando Match Sem Prioridade, ou seja, está na Fila do Match Diário), `waiting_for_match_with_priority` (aguardando Match Com Prioridade, ou seja, está na Fila do Match Manual),  `waived` (desistência), `waiting_for_confirmation` (aguardando confirmação do Match com a Voluntária).\"\n            },\n            {\n                column_name: \"created_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp de criação do Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"updated_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp da última atualização da linha.\"\n            }\n            \n        ]\n    }\n\n]\n\nconst dbSchemaAsString = JSON.stringify(dbSchema);\n  \nreturn dbSchemaAsString"
      },
      "id": "48829551-8f31-43ed-9062-8863cafdc36b",
      "name": "DB Schema",
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.1,
      "position": [
        920,
        580
      ]
    },
    {
      "parameters": {
        "trigger": [
          "app_mention"
        ],
        "channelId": {
          "__rl": true,
          "value": "C08CEV428KA",
          "mode": "list",
          "cachedResultName": "iana-teste"
        },
        "options": {}
      },
      "id": "ff108c54-5960-4255-aa93-327925c79c5b",
      "name": "Slack Trigger",
      "type": "n8n-nodes-base.slackTrigger",
      "typeVersion": 1,
      "position": [
        560,
        320
      ],
      "webhookId": "81fed1bc-51bd-40d7-b383-a4864b350e90",
      "credentials": {
        "slackApi": {
          "id": "Dg49PbVFaboa5OhZ",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "C08CEV428KA",
          "mode": "list",
          "cachedResultName": "iana-teste"
        },
        "text": "={{ $fromAI(\"answer\",\"answer to user's question\") }}",
        "otherOptions": {}
      },
      "id": "77f17a03-a215-458c-882b-0202bb543b93",
      "name": "Slack",
      "type": "n8n-nodes-base.slackTool",
      "typeVersion": 2.2,
      "position": [
        1500,
        440
      ],
      "webhookId": "744079f9-7b23-4d77-874c-5205840ebd9d",
      "credentials": {
        "slackOAuth2Api": {
          "id": "01G85hUbLT4VlY92",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "agent": "openAiFunctionsAgent",
        "promptType": "define",
        "text": "={{ $json.blocks[0].elements[0].elements[1].text }}",
        "options": {
          "systemMessage": "You are DB assistant. You need to run queries in DB aligned with user requests.\n\nYou should take the following steps:\n1. Call the db_schema tool to understand the database schema and table descriptions. \n2. Use the obtained db_schema to to create a SQL query that answers the user's question\n3. Call the Run SQL query tool to run the query that you just created.\n4. Fetch the results and use the Slack tool to send a message answering the user's question.\n\nFetch all data to analyse it for response if needed.\n"
        }
      },
      "id": "2bba807f-bfa9-4560-bde0-46d3344aeab3",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        840,
        320
      ],
      "typeVersion": 1.6
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "f0d96215-fe33-48a7-9890-ab02f969ef8d",
      "name": "OpenAI Chat Model1",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        760,
        1080
      ],
      "typeVersion": 1,
      "credentials": {
        "openAiApi": {
          "id": "oXPQUooT35CwTcvu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Run custom SQL queries using knowledge about Output structure to provide needed response for user request.\nUse ->> operator to extract JSON data.",
        "operation": "executeQuery",
        "query": "{{ $fromAI(\"query\",\"SQL query for PostgreSQL DB\") }}",
        "options": {}
      },
      "id": "65f603f1-8f03-4886-87d8-04509a2b9d38",
      "name": "Run SQL Query1",
      "type": "n8n-nodes-base.postgresTool",
      "position": [
        1080,
        1080
      ],
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "c5mNsjWNXx3mw1Fh",
          "name": "[PROD] Mapa"
        }
      }
    },
    {
      "parameters": {
        "name": "db_schema",
        "description": "Call this tool to get a description of the DB Schema",
        "jsCode": "const dbSchema = \n[\n    {\n        table_name: \"msr.msrs\",\n        table_description: \"Essa tabela contém as informações das MSRs (Mulher em Situação de Risco) atendidas pelo Mapa do Acolhimento. Essa tabela contém informações que não são PII.\",\n        table_columns: [\n            {\n                column_name: \"msr_id\",\n                column_type: \"BIGINT\",\n                column_description: \"ID único da MSR. Também corresponde ao user ID do Zendesk.\"\n            },\n            {\n                column_name: \"gender\",\n                column_type: \"ENUM\",\n                column_description: \"Gênero da MSR. As opções são: cis_woman (mulher cis), trans_woman (mulher trans) e not_found (informação não disponível).\"\n            },\n            {\n                column_name: \"race_color\",\n                column_type: \"ENUM\",\n                column_description: \"Raça e/ou cor da MSR. As opções são black (preta), brown (parda), indigenous (indígena), white (branca), yellow (amarela), not_found (informação não disponível).\"\n            },\n            {\n                column_name: \"has_disability\",\n                column_type: \"BOOL\",\n                column_description: \"Indica se a MSR tem deficiência. Pode ser nulo, caso essa informação não esteja disponível.\"\n            },\n            {\n                column_name: \"accepts_online_support\",\n                column_type: \"BOOL\",\n                column_description: \"Indica se a MSR aceita receber atendimento online.\"\n            },\n            {\n                column_name: \"zipcode\",\n                column_type: \"VARCHAR\",\n                column_description: \"Zipcode (ou CEP, no Brasil) da MSR.\"\n            },\n            {\n                column_name: \"neighborhood\",\n                column_type: \"VARCHAR\",\n                column_description: \"Bairro da MSR.\"\n            },\n            {\n                column_name: \"city\",\n                column_type: \"VARCHAR\",\n                column_description: \"Cidade da MSR. Todos os valores estão em upper case e sem caracteres especiais.\"\n            },\n            {\n                column_name: \"state\",\n                column_type: \"VARCHAR\",\n                column_description: \"Sigla do Estado da MSR.\"\n            },\n            {\n                column_name: \"status\",\n                column_type: \"ENUM\",\n                column_description: \"Status atual da MSR. As opções são `registered` (cadastrada) e `unregistered` (descadastrada).\"\n            },\n            {\n                column_name: \"created_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp de cadastro da MSR.\"\n            },\n            {\n                column_name: \"updated_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp da última atualização da linha.\"\n            }\n        ]\n    },\n    {\n        table_name: \"pii_sec.msr_pii\",\n        table_description: \"Essa tabela contém as informações das MSRs (Mulher em Situação de Risco) atendidas pelo Mapa do Acolhimento. Essa tabela contém informações que são PII.\",\n        table_columns: [\n            {\n                column_name: \"msr_id\",\n                column_type: \"BIGINT\",\n                column_description: \"ID único da MSR. Também corresponde ao user ID do Zendesk.\"\n            },\n            {\n                column_name: \"first_name\",\n                column_type: \"VARCHAR\",\n                column_description: \"Primeiro nome da MSR.\"\n            },\n            {\n                column_name: \"email\",\n                column_type: \"VARCHAR\",\n                column_description: \"E-mail da MSR.\"\n            },\n            {\n                column_name: \"phone\",\n                column_type: \"VARCHAR\",\n                column_description: \"Telefone da MSR.\"\n            },\n            {\n                column_name: \"date_of_birth\",\n                column_type: \"DATETIME\",\n                column_description: \"Data de nascimento da MSR. Pode ser nulo se essa informação não estiver disponível.\"\n            },\n            {\n                column_name: \"created_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp de cadastro da MSR.\"\n            },\n            {\n                column_name: \"updated_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp da última atualização da linha.\"\n            }\n        ]\n    },\n    {\n        table_name: \"msr.msr_status_history\",\n        table_description: \"Essa tabela contém o histórico de status das MSRs (Mulher em Situação de Risco) atendidas pelo Mapa do Acolhimento.\",\n        table_columns: [\n            {\n                column_name: \"msr_status_history_id\",\n                column_type: \"INT\",\n                column_description: \"ID único da tabela.\"\n            },\n            {\n                column_name: \"msr_id\",\n                column_type: \"BIGINT\",\n                column_description: \"ID único da MSR. Também corresponde ao user ID do Zendesk.\"\n            },\n            {\n                column_name: \"status\",\n                column_type: \"ENUM\",\n                column_description: \"Status da MSR. As opções são `registered` (cadastrada) e `unregistered` (descadastrada)\"\n            },\n            {\n                column_name: \"created_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp de criação desse status.\"\n            },\n        ]\n    },\n    {\n        table_name: \"match.support_requests\",\n        table_description: \"Essa tabela contém as informações dos Pedidos de Acolhimento recebidos pelo Mapa do Acolhimento. Cada Pedido de Acolhimento é realizado por uma MSR (Mulher em Situação de Risco) quando ela se cadastra em nossa plataforma.\",\n        table_columns: [\n            {\n                column_name: \"support_request_id\",\n                column_type: \"INT\",\n                column_description: \"ID único do Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"msr_id\",\n                column_type: \"BIGINT\",\n                column_description: \"ID da MSR que realizou o Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"zendesk_ticket_id\",\n                column_type: \"INT\",\n                column_description: \"ID do ticket do Zendesk que corresponde ao Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"support_type\",\n                column_type: \"ENUM\",\n                column_description: \"Tipo de Acolhimento. As opções são `legal` (jurídico) e `psychological` (psicológico).\"\n            },\n            {\n                column_name: \"lat\",\n                column_type: \"DECIMAL\",\n                column_description: \"Latitude da MSR que realizou o Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"lng\",\n                column_type: \"DECIMAL\",\n                column_description: \"Longitude da MSR que realizou o Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"city\",\n                column_type: \"VARCHAR\",\n                column_description: \"Cidade da MSR que realizou o Pedido de Acolhimento. Todos os valores estão em upper case e sem caracteres especiais.\"\n            },\n            {\n                column_name: \"state\",\n                column_type: \"VARCHAR\",\n                column_description: \"Sigla do Estado da MSR que realizou o Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"status\",\n                column_type: \"ENUM\",\n                column_description: \"Status atual do Pedido de Acolhimento. As opções são `open` (solicitação recebida, ou seja, o Pedido de Acolhimento ainda não foi processado),  `matched` (match com uma Voluntária),  `social_worker` (encaminhado para a Assistente Social), `public_service` (encaminhado para Serviço Público), `duplicated` (solicitação repetida), `closed` (solicitação encerrada), `public_service_with_social_worker` (encaminhado para Serviço Público através da Assistente Social), `scheduled_social_worker` (entrevista com a Assistente Social agendada), `expired_social_worker` (entrevista com a Assistente Social com prazo expirado), `waiting_for_match` (aguardando Match Sem Prioridade, ou seja, está na Fila do Match Diário), `waiting_for_match_with_priority` (aguardando Match Com Prioridade, ou seja, está na Fila do Match Manual),  `waived` (desistência), `waiting_for_confirmation` (aguardando confirmação do Match com a Voluntária).\"\n            },\n            {\n                column_name: \"created_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp de criação do Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"updated_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp da última atualização da linha.\"\n            }\n            \n        ]\n    },\n    {\n        table_name: \"match.support_request_status_history\",\n        table_description: \"Essa tabela contém o histórico de status dos Pedidos de Acolhimento recebidos pelo Mapa do Acolhimento.\",\n        table_columns: [\n            {\n                column_name: \"support_request_status_history_id\",\n                column_type: \"INT\",\n                column_description: \"ID único da tabela.\"\n            },\n            {\n                column_name: \"support_request_id\",\n                column_type: \"INT\",\n                column_description: \"ID único do Pedido de Acolhimento.\"\n            },\n            {\n                column_name: \"status\",\n                column_type: \"ENUM\",\n                column_description: \"Status do Pedido de Acolhimento. As opções são `open` (solicitação recebida, ou seja, o Pedido de Acolhimento ainda não foi processado),  `matched` (match com uma Voluntária),  `social_worker` (encaminhado para a Assistente Social), `public_service` (encaminhado para Serviço Público), `duplicated` (solicitação repetida), `closed` (solicitação encerrada), `public_service_with_social_worker` (encaminhado para Serviço Público através da Assistente Social), `scheduled_social_worker` (entrevista com a Assistente Social agendada), `expired_social_worker` (entrevista com a Assistente Social com prazo expirado), `waiting_for_match` (aguardando Match Sem Prioridade, ou seja, está na Fila do Match Diário), `waiting_for_match_with_priority` (aguardando Match Com Prioridade, ou seja, está na Fila do Match Manual),  `waived` (desistência), `waiting_for_confirmation` (aguardando confirmação do Match com a Voluntária).\"\n            },\n            {\n                column_name: \"created_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp de criação desse status.\"\n            },\n        ]\n    },\n    {\n        table_name: \"match.matches\",\n        table_description: \"Essa tabela contém as informações dos Matches criados pelo Mapa do Acolhimento. Cada Match corresponde a conectar um Pedido de Acolhimento, feito por uma MSR, a uma Voluntária.\",\n        table_columns: [\n            {\n                column_name: \"match_id\",\n                column_type: \"INT\",\n                column_description: \"ID único do Match.\"\n            },\n            {\n                column_name: \"support_request_id\",\n                column_type: \"INT\",\n                column_description: \"ID do Pedido de Acolhimento que corresponde a este Match.\"\n            },\n            {\n                column_name: \"msr_id\",\n                column_type: \"BIGINT\",\n                column_description: \"ID da MSR que realizou o Pedido de Acolhimento e recebeu o Match.\"\n            },\n            {\n                column_name: \"msr_zendesk_ticket_id\",\n                column_type: \"INT\",\n                column_description: \"ID do ticket do Zendesk da MSR que corresponde ao Match.\"\n            },\n            {\n                column_name: \"volunteer_zendesk_ticket_id\",\n                column_type: \"INT\",\n                column_description: \"ID do ticket do Zendesk da Voluntária que corresponde ao Match.\"\n            },\n            {\n                column_name: \"support_type\",\n                column_type: \"ENUM\",\n                column_description: \"Tipo de Acolhimento. As opções são `legal` (jurídico) e `psychological` (psicológico).\"\n            },\n            {\n                column_name: \"match_type\",\n                column_type: \"ENUM\",\n                column_description: \"Tipo de Match. As opções são `msr` (Match feito com o Novo Match no cadastro da MSR), `daily` (Match Diário), `manual` (Match Manual) e `old` (Match Automatizado, realizado antes de 2024).\"\n            },\n            {\n                column_name: \"match_stage\",\n                column_type: \"ENUM\",\n                column_description: \"Etapa em que o Match foi realizado. As opções são `ideal` (Match Ideal), `expanded` (Match Expandido), `online` (Match Online), `manual` (Match Manual, não possui etapas), `old` (Match realizado antes de 2024, quando não existia essa lógica do Match em etapas).\"\n            },\n            {\n                column_name: \"status\",\n                column_type: \"ENUM\",\n                column_description: \"Status atual do Match. As opções são `waiting_contact` (Encaminhamento Realizado, ou seja, o Match está aguardando contato, pois a MSR ainda não entrou em contato com a Voluntária),  `in_contact` (Atendimento Iniciado, a MSR e a Voluntária iniciaram o atendimento),  `interrupted_before_support` (Encaminhamento Interrompido, ou seja, o Match foi interrompido antes de o atendimento iniciar), `interrupted_after_support` (Atendimento Interrompido, ou seja, o Match foi interrompido após iniciar o atendimento), `expired` (Encaminhamento Expirado, ou seja, a MSR não entrou em contato com a Voluntária após 15 dias e, por isso, o Match expirou), `completed` (Atendimento Concluído, ou seja, o atendimento foi concluído com sucesso). Caso você seja perguntado sobre Matches que iniciaram atendimento, você deve considerar os seguintes status: `in_contact`, `interrupted_after_support` e `completed` para responder.\"\n            },\n            {\n                column_name: \"created_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp de criação do Match.\"\n            },\n            {\n                column_name: \"updated_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp da última atualização da linha.\"\n            }\n            \n        ]\n    },\n    {\n        table_name: \"match.match_status_history\",\n        table_description: \"Essa tabela contém o histórico de status dos Matches realizados pelo Mapa do Acolhimento.\",\n        table_columns: [\n            {\n                column_name: \"match_status_history_id\",\n                column_type: \"INT\",\n                column_description: \"ID único da tabela.\"\n            },\n            {\n                column_name: \"match_id\",\n                column_type: \"INT\",\n                column_description: \"ID único do Match.\"\n            },\n            {\n                column_name: \"status\",\n                column_type: \"ENUM\",\n                column_description: \"Status do Match. As opções são `waiting_contact` (Encaminhamento Realizado, ou seja, o Match está aguardando contato, pois a MSR ainda não entrou em contato com a Voluntária),  `in_contact` (Atendimento Iniciado, a MSR e a Voluntária iniciaram o atendimento),  `interrupted_before_support` (Encaminhamento Interrompido, ou seja, o Match foi interrompido antes de o atendimento iniciar), `interrupted_after_support` (Atendimento Interrompido, ou seja, o Match foi interrompido após iniciar o atendimento), `expired` (Encaminhamento Expirado, ou seja, a MSR não entrou em contato com a Voluntária após 15 dias e, por isso, o Match expirou), `completed` (Atendimento Concluído, ou seja, o atendimento foi concluído com sucesso).\"\n            },\n            {\n                column_name: \"created_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp de criação desse status.\"\n            },\n        ]\n    },\n    {\n        table_name: \"match.match_confirmations\",\n        table_description: \"Essa tabela contém as informações das Confirmações de Match, enviadas pelo Mapa do Acolhimento para as Voluntárias. Em alguns casos, antes de realizar o Match entre MSR e Voluntária, o Mapa envia uma mensagem para a Voluntária por WhatsApp, pedindo para que ela confirme se está disponível para atender a MSR.\",\n        table_columns: [\n            {\n                column_name: \"match_confirmation_id\",\n                column_type: \"INT\",\n                column_description: \"ID único da Confirmação de Match.\"\n            },\n            {\n                column_name: \"support_request_id\",\n                column_type: \"INT\",\n                column_description: \"ID do Pedido de Acolhimento que corresponde a esta Confirmação de Match.\"\n            },\n            {\n                column_name: \"msr_id\",\n                column_type: \"BIGINT\",\n                column_description: \"ID da MSR que realizou o Pedido de Acolhimento e está aguardando a Confirmação do Match.\"\n            },\n            {\n                column_name: \"volunteer_id\",\n                column_type: \"INT\",\n                column_description: \"ID da Voluntária que recebeu a Confirmação de Match.\"\n            },\n\n            {\n                column_name: \"match_type\",\n                column_type: \"ENUM\",\n                column_description: \"Tipo de Match. As opções são `msr` (Match feito com o Novo Match no cadastro da MSR), `daily` (Match Diário), `manual` (Match Manual) e `old` (Match Automatizado, realizado antes de 2024).\"\n            },\n            {\n                column_name: \"match_stage\",\n                column_type: \"ENUM\",\n                column_description: \"Etapa em que o Match foi realizado. As opções são `ideal` (Match Ideal), `expanded` (Match Expandido), `online` (Match Online), `manual` (Match Manual, não possui etapas), `old` (Match realizado antes de 2024, quando não existia essa lógica do Match em etapas).\"\n            },\n            {\n                column_name: \"status\",\n                column_type: \"ENUM\",\n                column_description: \"Status atual da Confirmação do Match. As opções são `waiting` (aguardando resposta da Voluntária),  `accepted` (a Voluntária confirmou o Match),  `denied` (a Voluntária negou o match), `expired` (a Voluntária não respondeu após 24h e, por isso, a Confirmação de Match expirou).\"\n            },\n            {\n                column_name: \"created_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp de criação da Confirmação do Match.\"\n            },\n            {\n                column_name: \"updated_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp da última atualização da linha.\"\n            }\n            \n        ]\n    },\n    {\n        table_name: \"match.match_confirmation_status_history\",\n        table_description: \"Essa tabela contém o histórico de status da Confirmação de Match.\",\n        table_columns: [\n            {\n                column_name: \"match_confirmation_status_history_id\",\n                column_type: \"INT\",\n                column_description: \"ID único da tabela.\"\n            },\n            {\n                column_name: \"match_confirmation_id\",\n                column_type: \"INT\",\n                column_description: \"ID único da Confirmação de Match.\"\n            },\n            {\n                column_name: \"status\",\n                column_type: \"ENUM\",\n                column_description: \"Status da Confirmação do Match. As opções são `waiting` (aguardando resposta da Voluntária),  `accepted` (a Voluntária confirmou o Match),  `denied` (a Voluntária negou o match), `expired` (a Voluntária não respondeu após 24h e, por isso, a Confirmação de Match expirou).\"\n            },\n            {\n                column_name: \"created_at\",\n                column_type: \"TIMESTAMP\",\n                column_description: \"Timestamp de criação desse status.\"\n            },\n        ]\n    },\n    \n\n]\n\nconst dbSchemaAsString = JSON.stringify(dbSchema);\n  \nreturn dbSchemaAsString"
      },
      "id": "e1490f9f-dbda-4ca9-b06e-906de9f22e07",
      "name": "DB Schema1",
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.1,
      "position": [
        900,
        1080
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "a00afebc-00ca-46a1-a70e-b5c249ffe32c",
      "name": "When chat message received",
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        540,
        820
      ],
      "webhookId": "e35dd096-adcb-40ea-840b-c5d874306bd4"
    },
    {
      "parameters": {},
      "id": "1eedc4cc-d42d-4b05-b155-bf44913bc04b",
      "name": "Calculator",
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        1220,
        1040
      ]
    },
    {
      "parameters": {
        "agent": "openAiFunctionsAgent",
        "promptType": "define",
        "text": "={{ $json.chatInput }}",
        "options": {
          "systemMessage": "You are DB assistant. Your name is IAna. You work for Mapa do Acolhimento, a non-profit organization that matches survivors of gender-based violence with volunteer psychologists and lawyers across Brazil. \n\nAs a DB assistant, your role is to answer questions about Mapa do Acolhimento's database.\n\nYou need to run queries in DB aligned with user requests.\n\nYou should take the following steps:\n1. Call the db_schema tool to understand the database schema and table descriptions. \n2. Use the obtained db_schema to to create a SQL query that answers the user's question. You should use PostgreSQL.\n3. Call the Run SQL query tool to run the query that you just created.\n4. If you need to perform any calculations, you can use the Calculator tool. If your query is too complex, make it simpler and use the calculator tool to calculate the results.\n5. Obtain the results and answer the user's question.\n6. Use markdown to format your answer.\n\nFetch all data to analyse it for response if needed.\n\nBe friendly."
        }
      },
      "id": "4f1754e7-8b72-46c3-b99f-e2ecf80b904f",
      "name": "AI Agent1",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        820,
        820
      ],
      "typeVersion": 1.6
    }
  ],
  "pinData": {
    "Slack Trigger": [
      {
        "json": {
          "user": "U06DJMAQUQ0",
          "type": "app_mention",
          "ts": "1738702153.025939",
          "client_msg_id": "a85e2a6c-22f0-4b53-97d6-5874825b68f1",
          "text": "<@U08C4SF6049> oi",
          "team": "T0513P26WV8",
          "blocks": [
            {
              "type": "rich_text",
              "block_id": "Fj9zq",
              "elements": [
                {
                  "type": "rich_text_section",
                  "elements": [
                    {
                      "type": "user",
                      "user_id": "U08C4SF6049"
                    },
                    {
                      "type": "text",
                      "text": " oi"
                    }
                  ]
                }
              ]
            }
          ],
          "channel": "C08CEV428KA",
          "event_ts": "1738702153.025939"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-02-04T19:57:24.855Z",
      "updatedAt": "2025-02-04T19:57:24.855Z",
      "role": "workflow:owner",
      "workflowId": "uE1tYxILaoI1yyCg",
      "projectId": "rfgBK87HsySgxYKT",
      "project": {
        "createdAt": "2024-11-15T08:07:36.637Z",
        "updatedAt": "2024-11-15T08:07:36.637Z",
        "id": "rfgBK87HsySgxYKT",
        "name": "Desenvolvimento Mapa <dev@mapa.org.br>",
        "type": "personal",
        "projectRelations": [
          {
            "createdAt": "2024-11-15T08:07:36.637Z",
            "updatedAt": "2024-11-15T08:07:36.637Z",
            "role": "project:personalOwner",
            "userId": "6e437c36-d4e0-42f4-bbc3-d9b5ac96e474",
            "projectId": "rfgBK87HsySgxYKT",
            "user": {
              "createdAt": "2024-01-09T22:21:28.810Z",
              "updatedAt": "2024-12-10T20:48:45.029Z",
              "id": "6e437c36-d4e0-42f4-bbc3-d9b5ac96e474",
              "email": "dev@mapa.org.br",
              "firstName": "Desenvolvimento",
              "lastName": "Mapa",
              "personalizationAnswers": null,
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "sMoToF9HauyKvsFJ",
                "isOnboarded": true,
                "userActivatedAt": 1731658062996,
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1733863720858
                }
              },
              "role": "global:owner",
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false,
              "isOwner": true
            }
          }
        ]
      }
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 3,
  "updatedAt": "2025-02-11T21:18:54.000Z",
  "versionId": "0a687608-7d45-45cc-a87e-531e0fb79a36"
}