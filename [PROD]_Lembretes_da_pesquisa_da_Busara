{
  "active": true,
  "connections": {
    "Inicia export das respostas da survey": {
      "main": [
        [
          {
            "node": "Aguarda o export terminar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aguarda o export terminar": {
      "main": [
        [
          {
            "node": "Verifica o status do export",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verifica o status do export": {
      "main": [
        [
          {
            "node": "Terminou de exportar as respostas?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Terminou de exportar as respostas?": {
      "main": [
        [
          {
            "node": "Obtém as respostas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Aguarda o export terminar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Espera 5 segundos4": {
      "main": [
        [
          {
            "node": "[NÃO RESPODERAM] Envia email da segunda pesquisa para as que não concluíram a primeira",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items4": {
      "main": [
        [
          {
            "node": "No Operation, do nothing4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Espera 5 segundos4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MSRs que responderam a primeira pesquisa": {
      "main": [
        [
          {
            "node": "Join pelo hash",
            "type": "main",
            "index": 0
          },
          {
            "node": "Join pelo hash1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Join pelo hash": {
      "main": [
        [
          {
            "node": "Começaram mas não concluíram",
            "type": "main",
            "index": 0
          },
          {
            "node": "Concluíram a pesquisa",
            "type": "main",
            "index": 0
          },
          {
            "node": "Nem começaram a pesquisa1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Envia email de lembrete para as que nem começaram1": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Espera 5 segundos1": {
      "main": [
        [
          {
            "node": "Envia email de lembrete para as que nem começaram1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items2": {
      "main": [
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Espera 5 segundos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Envia email de lembrete para as que não finalizaram1": {
      "main": [
        [
          {
            "node": "Loop Over Items5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Espera 5 segundos5": {
      "main": [
        [
          {
            "node": "Envia email de lembrete para as que não finalizaram1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items5": {
      "main": [
        [
          {
            "node": "No Operation, do nothing6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Espera 5 segundos5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Exclui algumas MSRs": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca MSRs que se cadastraram há 3 meses1": {
      "main": [
        [
          {
            "node": "Busca e-mails e nomes de todas as MSRs2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca e-mails e nomes de todas as MSRs2": {
      "main": [
        [
          {
            "node": "Busca e-mails e hashes3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca MSRs que se cadastraram há 7 dias": {
      "main": [
        [
          {
            "node": "Busca e-mails e nomes de todas as MSRs4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca e-mails e nomes de todas as MSRs4": {
      "main": [
        [
          {
            "node": "Busca e-mails e hashes4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca e-mails e hashes4": {
      "main": [
        [
          {
            "node": "Filtra apenas as que possuem primeiro nome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Concluíram a pesquisa": {
      "main": [
        [
          {
            "node": "No Operation, do nothing5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtra apenas as que possuem primeiro nome": {
      "main": [
        [
          {
            "node": "Join pelo hash",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Busca e-mails e hashes3": {
      "main": [
        [
          {
            "node": "Filtra apenas as que possuem primeiro nome1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtra apenas as que possuem primeiro nome1": {
      "main": [
        [
          {
            "node": "Join pelo hash1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Join pelo hash1": {
      "main": [
        [
          {
            "node": "Concluíram a primeira fase da pesquisa",
            "type": "main",
            "index": 0
          },
          {
            "node": "Não concluíram a primeira fase da pesquisa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Espera 5 segundos6": {
      "main": [
        [
          {
            "node": "[RESPODERAM] Envia email da segunda pesquisa para as que concluíram a primeira",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items6": {
      "main": [
        [
          {
            "node": "No Operation, do nothing7",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Espera 5 segundos6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[RESPODERAM] Envia email da segunda pesquisa para as que concluíram a primeira": {
      "main": [
        [
          {
            "node": "Loop Over Items6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[NÃO RESPODERAM] Envia email da segunda pesquisa para as que não concluíram a primeira": {
      "main": [
        [
          {
            "node": "Loop Over Items4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtém as respostas": {
      "main": [
        [
          {
            "node": "MSRs que responderam a primeira pesquisa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Concluíram a primeira fase da pesquisa": {
      "main": [
        [
          {
            "node": "Loop Over Items6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Não concluíram a primeira fase da pesquisa": {
      "main": [
        [
          {
            "node": "Loop Over Items4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Começaram mas não concluíram": {
      "main": [
        [
          {
            "node": "Loop Over Items5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Nem começaram a pesquisa1": {
      "main": [
        [
          {
            "node": "Exclui algumas MSRs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Busca MSRs que se cadastraram há 3 meses1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Inicia export das respostas da survey",
            "type": "main",
            "index": 0
          },
          {
            "node": "Busca MSRs que se cadastraram há 7 dias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2024-05-22T20:31:45.914Z",
  "id": "zTWBDnUOqcxHumuF",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "[PROD] Lembretes da pesquisa da Busara",
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "https://iad1.qualtrics.com/API/v3/surveys/SV_3ltkrtQdVfXYEt0/export-responses",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "format",
              "value": "json"
            },
            {
              "name": "compress",
              "value": "false"
            },
            {
              "name": "questionIds",
              "value": "={{ [] }}"
            },
            {
              "name": "surveyMetadataIds",
              "value": "={{ ['finished'] }}"
            },
            {
              "name": "embeddedDataIds",
              "value": "={{ ['user_id'] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "d5ca9db4-f34c-4abd-9158-9e5a124df32d",
      "name": "Inicia export das respostas da survey",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1840,
        2551
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "ZSugxhtsMkxobBKb",
          "name": "Busara Qualtrics API"
        }
      }
    },
    {
      "parameters": {
        "amount": 10,
        "unit": "seconds"
      },
      "id": "0c065866-74a7-400a-8ebb-8defcebb3e4e",
      "name": "Aguarda o export terminar",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        2060,
        2551
      ],
      "webhookId": "73366a6d-fcca-490a-88c1-eda5b9aeaca6"
    },
    {
      "parameters": {
        "url": "=https://iad1.qualtrics.com/API/v3/surveys/SV_3ltkrtQdVfXYEt0/export-responses/{{ $json.result.progressId }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "54f22597-7c08-4ae1-bb45-b1320cd5b7ee",
      "name": "Verifica o status do export",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2260,
        2551
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "ZSugxhtsMkxobBKb",
          "name": "Busara Qualtrics API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "f0b7e6b7-2a50-4082-8986-3ffb4437610e",
              "leftValue": "={{ $json.result.status }}",
              "rightValue": "complete",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "bb63ad80-8dbe-4a43-8bda-987e979f86c8",
      "name": "Terminou de exportar as respostas?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2460,
        2551
      ]
    },
    {
      "parameters": {
        "url": "=https://iad1.qualtrics.com/API/v3/surveys/SV_3ltkrtQdVfXYEt0/export-responses/{{ $json.result.fileId }}/file",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "c9b370bb-46ab-4c9f-bfcd-d0dd8b1d30a7",
      "name": "Obtém as respostas",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2680,
        2531
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "ZSugxhtsMkxobBKb",
          "name": "Busara Qualtrics API"
        }
      }
    },
    {
      "parameters": {
        "content": "### Bate na API do qualtrics (ferramenta utilizada pela Busara) para descobrir quais MSRs já responderam à primeira fase da pesquisa",
        "height": 80,
        "width": 929.688750616661,
        "color": 6
      },
      "id": "4fc5da32-8c67-49b2-8cd1-575e5d4d22cc",
      "name": "Sticky Note2",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1840,
        2420
      ]
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "4c99fae8-4530-4924-9cdf-325968a4c110",
      "name": "Espera 5 segundos4",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        4160,
        2140
      ],
      "webhookId": "53e639f9-bdf6-4971-b88e-19d668045c2f"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "43bf5322-e819-47ad-bb0b-a03e4cea55b7",
      "name": "Loop Over Items4",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3920,
        2120
      ]
    },
    {
      "parameters": {},
      "id": "95daab17-c25d-4768-ac55-5ddf1d99e9ff",
      "name": "No Operation, do nothing4",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4160,
        1960
      ]
    },
    {
      "parameters": {
        "content": "### Lembrete da primeira fase da pesquisa\nDeve ser enviado 7 dias após o cadastro, apenas para as MSRs que não concluíram a pesquisa",
        "height": 93.28827475490624,
        "width": 502.0441883135077,
        "color": 6
      },
      "id": "6d063677-c2f6-4257-9922-8d2e7c1c0442",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2160,
        3360
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "mergeByFields": {
          "values": [
            {
              "field1": "user_id",
              "field2": "user_id"
            }
          ]
        },
        "joinMode": "enrichInput2",
        "options": {
          "multipleMatches": "first"
        }
      },
      "id": "1361dcca-ba0c-4412-8845-b81027ca412a",
      "name": "Join pelo hash",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        3260,
        3480
      ]
    },
    {
      "parameters": {
        "jsCode": "const answers = $input.all()[0].json.responses;\n\nconst output = [];\n\nfor (const item of answers){\n  if(!!item.values.user_id)\n    output.push({\n      'user_id': item.values.user_id,\n      'started': 1,\n      'finished': item.values.finished,\n  \n    })\n}\n\nreturn output;"
      },
      "id": "05bb6e2b-6980-4b82-953b-14eb2932c7ac",
      "name": "MSRs que responderam a primeira pesquisa",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2920,
        2531
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.loops.so/api/v1/transactional",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n \"email\": \"{{ $json.email }}\",\n \"transactionalId\": \"clt68ffrx00811250n1tezdb7\",\n \"dataVariables\": {\n    \"name\": \"{{ $json.first_name }}\",\n   \"survey_link\": \"{{ $json.survey_link }}\"\n  }\n}",
        "options": {}
      },
      "id": "d3a12296-a175-45b2-871a-6c6b68285e49",
      "name": "Envia email de lembrete para as que nem começaram1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        4700,
        4511
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "XrvtxHAVgwwJ3r6q",
          "name": "Loops API"
        }
      }
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "cf5bd63f-00f2-4705-b363-2935f0538c7c",
      "name": "Espera 5 segundos1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        4440,
        4511
      ],
      "webhookId": "c3197a08-e58e-4e3f-8ea4-99afcc885614"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "6a38c369-234f-4ef9-9c79-02893e4d0dcf",
      "name": "Loop Over Items2",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        4160,
        4491
      ]
    },
    {
      "parameters": {},
      "id": "2e995b9b-4e12-4ffa-b657-aeb39864d94f",
      "name": "No Operation, do nothing2",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4440,
        4311
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.loops.so/api/v1/transactional",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n \"email\": \"{{ $json.email }}\",\n \"transactionalId\": \"clt661u05008hr8356tdw4r77\",\n \"dataVariables\": {\n    \"name\": \"{{ $json.first_name }}\",\n   \"survey_link\": \"{{ $json.survey_link }}\"\n  }\n}",
        "options": {}
      },
      "id": "0638f33e-20f8-4222-859e-b837e22b8ff3",
      "name": "Envia email de lembrete para as que não finalizaram1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        4420,
        3991
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "XrvtxHAVgwwJ3r6q",
          "name": "Loops API"
        }
      }
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "c68d0238-17d5-409c-acbf-92ecdcf34ce4",
      "name": "Espera 5 segundos5",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        4180,
        3991
      ],
      "webhookId": "64dff24a-e09a-4b85-a5aa-b05c1034a747"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "4c4951cb-3166-4471-8eaa-1960e89e6c2f",
      "name": "Loop Over Items5",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3920,
        3971
      ]
    },
    {
      "parameters": {},
      "id": "b71aa3eb-4a7e-4cd9-911e-200765dce827",
      "name": "No Operation, do nothing6",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4180,
        3791
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "56f3c66e-fe97-41f0-8caf-027beb7ed20a",
              "leftValue": "={{ $json.started }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "b34da5c7-c790-4f46-9a9b-246a54ab34af",
      "name": "Nem começaram a pesquisa1",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3660,
        4480
      ]
    },
    {
      "parameters": {},
      "id": "46478669-5f66-4c39-ab31-17423d41238b",
      "name": "No Operation, do nothing5",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3880,
        3480
      ]
    },
    {
      "parameters": {
        "jsCode": "filter_out = ['naspimentel@hotmail.com', 'nayara.tenorio19@gmail.com', 'michellesantos2077@gmail.com', 'danielegomess00@hotmail.com', 'jaemilly2305@gmail.com', 'brunadayane2300@gmail.com', 'izaa.pnogueira@gmail.com', 'manfrealicia@gmail.com', 'larissagomes_enf@hotmail.com', 'vivianaglopes@gmail.com', 'raphaella.cds@gmail.com', 'debyeidam@gmail.com', 'deboratgs@hotmail.com', 'nat_mell@hotmail.com', 'andrezza.ag1@live.com', 'nandabpires@gmail.com', 'thayyzze@hotmail.com', 'thayyzze@hotmail.com', 'monalisalourenco@gmail.com', 'fridabarros25@gmail.com', 'marthajez2019@gmail.com', 'yasminvitoriag.deoliveira@outlook.com', 'egladisuniati@gmail.com']\n\noutput = []\n\nfor (const item of $input.all()) {\n  if(!filter_out.includes(item.json.email)) {\n    output.push(item)\n  }\n}\n\nreturn output;"
      },
      "id": "2ef8cf02-00a3-4a32-8854-1e1b1c22a709",
      "name": "Exclui algumas MSRs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3940,
        4491
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT DISTINCT msr_id\nFROM match.support_requests\nWHERE \n  DATE_TRUNC('day', created_at) = (CURRENT_DATE - INTERVAL '90 DAYS')\n  AND status != 'duplicated'",
        "options": {}
      },
      "id": "840d83a6-8028-4241-bb58-a44e662f1f52",
      "name": "Busca MSRs que se cadastraram há 3 meses1",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        2040,
        1600
      ],
      "credentials": {
        "postgres": {
          "id": "c5mNsjWNXx3mw1Fh",
          "name": "[PROD] Mapa"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    '{{ $json.first_name }}' first_name,\n    msr_email AS email,\n    hash AS user_id,\n    CONCAT('https://busara.iad1.qualtrics.com/jfe/form/SV_bfpbu1KfIDj34Q6?user_id=', hash) AS survey_link\nFROM match.busara_hashes\nwhere msr_email = '{{ $json.email }}'",
        "options": {}
      },
      "id": "f815d685-513d-4794-ac5a-8a578bf0d928",
      "name": "Busca e-mails e hashes3",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        2460,
        1600
      ],
      "credentials": {
        "postgres": {
          "id": "c5mNsjWNXx3mw1Fh",
          "name": "[PROD] Mapa"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  user_id AS msr_id, \n  email,\n  SPLIT_PART(name, ' ', 1) AS first_name\nFROM solidarity_users\nWHERE organization_id = 360273031591\nAND user_id = {{ $json.msr_id }}",
        "options": {}
      },
      "id": "4b755a28-1a22-43a1-9fa1-b5d64208a686",
      "name": "Busca e-mails e nomes de todas as MSRs2",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        2260,
        1600
      ],
      "credentials": {
        "postgres": {
          "id": "GPnWI2OL5IjBv3zm",
          "name": "[PROD] Bonde"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  user_id AS msr_id, \n  email,\n  SPLIT_PART(name, ' ', 1) AS first_name\nFROM solidarity_users\nWHERE organization_id = 360273031591\nAND user_id = {{ $json.msr_id }}",
        "options": {}
      },
      "id": "0ad303a2-55d5-48d8-b48a-e6b5852b7428",
      "name": "Busca e-mails e nomes de todas as MSRs4",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        2440,
        3500
      ],
      "credentials": {
        "postgres": {
          "id": "GPnWI2OL5IjBv3zm",
          "name": "[PROD] Bonde"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  DISTINCT msr_id  \nFROM match.support_requests\nWHERE \n  DATE_TRUNC('day', created_at) = (CURRENT_DATE - INTERVAL '7 DAYS')\n  AND status != 'duplicated'",
        "options": {}
      },
      "id": "419c69f8-a364-4d35-8ff5-c02de5ec2cd8",
      "name": "Busca MSRs que se cadastraram há 7 dias",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        2160,
        3500
      ],
      "credentials": {
        "postgres": {
          "id": "c5mNsjWNXx3mw1Fh",
          "name": "[PROD] Mapa"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    '{{ $json.first_name }}' first_name,\n    msr_email AS email,\n    hash AS user_id,\n    CONCAT('https://busara.iad1.qualtrics.com/jfe/form/SV_bfpbu1KfIDj34Q6?user_id=', hash) AS survey_link\nFROM match.busara_hashes\nwhere msr_email = '{{ $json.email }}'",
        "options": {}
      },
      "id": "f57f5ddf-115c-4965-98f6-e3a29779833c",
      "name": "Busca e-mails e hashes4",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        2680,
        3500
      ],
      "credentials": {
        "postgres": {
          "id": "c5mNsjWNXx3mw1Fh",
          "name": "[PROD] Mapa"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "56f3c66e-fe97-41f0-8caf-027beb7ed20a",
              "leftValue": "={{ $json.started }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            },
            {
              "id": "07ce7ea8-8855-4a27-82fc-8f5655029354",
              "leftValue": "={{ $json.finished }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "6ae772d1-007a-4275-9929-6c0440c16bc0",
      "name": "Concluíram a pesquisa",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3660,
        3480
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "56f3c66e-fe97-41f0-8caf-027beb7ed20a",
              "leftValue": "={{ $json.started }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            },
            {
              "id": "07ce7ea8-8855-4a27-82fc-8f5655029354",
              "leftValue": "={{ $json.finished }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "1bb9b20f-f3f9-4e98-a65c-345531e44972",
      "name": "Começaram mas não concluíram",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3660,
        3971
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "22317f1c-3539-487f-b323-8bcc7a31ea92",
              "leftValue": "={{ $json.first_name }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "95ae3b48-1228-4bae-832d-0ccf3bccc372",
      "name": "Filtra apenas as que possuem primeiro nome",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        2900,
        3500
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "22317f1c-3539-487f-b323-8bcc7a31ea92",
              "leftValue": "={{ $json.first_name }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ab2bbe78-e350-4221-bea5-fb024438112a",
      "name": "Filtra apenas as que possuem primeiro nome1",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        2720,
        1600
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "mergeByFields": {
          "values": [
            {
              "field1": "user_id",
              "field2": "user_id"
            }
          ]
        },
        "joinMode": "enrichInput1",
        "options": {
          "multipleMatches": "first"
        }
      },
      "id": "44f59753-a172-4216-b955-8fe67fc85e6b",
      "name": "Join pelo hash1",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        3200,
        1620
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "56f3c66e-fe97-41f0-8caf-027beb7ed20a",
              "leftValue": "={{ $json.started }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            },
            {
              "id": "07ce7ea8-8855-4a27-82fc-8f5655029354",
              "leftValue": "={{ $json.finished }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "353c1513-8485-444c-ab51-357e8111da5b",
      "name": "Concluíram a primeira fase da pesquisa",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3560,
        1620
      ]
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "430787d3-cd56-4ae9-bde5-542a7af109f1",
      "name": "Espera 5 segundos6",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        4220,
        1640
      ],
      "webhookId": "ddfb14e0-b4d5-466b-bd39-73c25778238a"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "f97269ae-a414-4bb6-a9cd-0d8f2938f949",
      "name": "Loop Over Items6",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3960,
        1620
      ]
    },
    {
      "parameters": {},
      "id": "fa1266e6-52c3-4c5a-ab2f-d9aadceb8079",
      "name": "No Operation, do nothing7",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4220,
        1440
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "56f3c66e-fe97-41f0-8caf-027beb7ed20a",
              "leftValue": "={{ $json.finished }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "notExists",
                "singleValue": true
              }
            },
            {
              "id": "07ce7ea8-8855-4a27-82fc-8f5655029354",
              "leftValue": "={{ $json.finished }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "8463b2bf-7e10-4f50-87c7-62a8ee0994f3",
      "name": "Não concluíram a primeira fase da pesquisa",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3600,
        2120
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.loops.so/api/v1/transactional",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n \"email\": \"{{ $json.email }}\",\n \"transactionalId\": \"clvdteefr01569iklhmx72s8r\",\n \"dataVariables\": {\n    \"name\": \"{{ $json.first_name }}\",\n   \"survey_link\": \"{{ $json.survey_link }}&has_completed_baseline=true\"\n  }\n}",
        "options": {}
      },
      "id": "724858f0-3704-4e0d-a984-7a15c6928b35",
      "name": "[RESPODERAM] Envia email da segunda pesquisa para as que concluíram a primeira",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        4460,
        1640
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "XrvtxHAVgwwJ3r6q",
          "name": "Loops API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.loops.so/api/v1/transactional",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n \"email\": \"{{ $json.email }}\",\n \"transactionalId\": \"clvldt03j01dk14cjzi6g5u7l\",\n \"dataVariables\": {\n    \"name\": \"{{ $json.first_name }}\",\n   \"survey_link\": \"{{ $json.survey_link }}&has_completed_baseline=false\"\n  }\n}",
        "options": {}
      },
      "id": "5f0f4510-05e0-4547-a8ef-3a1ff699026f",
      "name": "[NÃO RESPODERAM] Envia email da segunda pesquisa para as que não concluíram a primeira",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        4360,
        2140
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "XrvtxHAVgwwJ3r6q",
          "name": "Loops API"
        }
      }
    },
    {
      "parameters": {
        "content": "### Envia a segunda fase da pesquisa\nDeve ser enviado 90 dias após o cadastro para todas as MSRs",
        "height": 93.28827475490624,
        "width": 502.0441883135077,
        "color": 6
      },
      "id": "1269abc5-8fbf-40cb-8255-41b838227d7d",
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2040,
        1440
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 9
            }
          ]
        }
      },
      "id": "21b2e2b4-3653-4538-b63c-44de7b24be25",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        1020,
        2560
      ]
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "HYstwqyTrzYsvJ2P"
  },
  "staticData": {
    "node:Schedule Trigger": {
      "recurrencyRules": []
    },
    "node:Schedule Trigger1": {
      "recurrencyRules": []
    }
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2024-05-22T20:33:00.000Z",
  "versionId": "b9c02b19-6d26-4bf5-8fe7-3d8466dad825"
}