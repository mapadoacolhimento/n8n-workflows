{
  "active": false,
  "connections": {
    "Inicia export das respostas da survey": {
      "main": [
        [
          {
            "node": "Aguarda o export terminar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aguarda o export terminar": {
      "main": [
        [
          {
            "node": "Verifica o status do export",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verifica o status do export": {
      "main": [
        [
          {
            "node": "Terminou de exportar as respostas?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Terminou de exportar as respostas?": {
      "main": [
        [
          {
            "node": "Obtém as respostas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Aguarda o export terminar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Espera 5 segundos4": {
      "main": [
        [
          {
            "node": "[NÃO RESPODERAM] Envia email da segunda pesquisa para as que não concluíram a primeira",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items4": {
      "main": [
        [
          {
            "node": "No Operation, do nothing4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Espera 5 segundos4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MSRs que responderam a primeira pesquisa": {
      "main": [
        [
          {
            "node": "Join pelo hash",
            "type": "main",
            "index": 0
          },
          {
            "node": "Join pelo hash1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Join pelo hash": {
      "main": [
        [
          {
            "node": "Começaram mas não concluíram",
            "type": "main",
            "index": 0
          },
          {
            "node": "Concluíram a pesquisa",
            "type": "main",
            "index": 0
          },
          {
            "node": "Nem começaram a pesquisa1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Envia email de lembrete para as que nem começaram1": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Espera 5 segundos1": {
      "main": [
        [
          {
            "node": "Envia email de lembrete para as que nem começaram1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items2": {
      "main": [
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Espera 5 segundos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Envia email de lembrete para as que não finalizaram1": {
      "main": [
        [
          {
            "node": "Loop Over Items5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Espera 5 segundos5": {
      "main": [
        [
          {
            "node": "Envia email de lembrete para as que não finalizaram1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items5": {
      "main": [
        [
          {
            "node": "No Operation, do nothing6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Espera 5 segundos5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Exclui algumas MSRs": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca MSRs que se cadastraram há 3 meses1": {
      "main": [
        [
          {
            "node": "Busca e-mails e nomes de todas as MSRs2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca e-mails e nomes de todas as MSRs2": {
      "main": [
        [
          {
            "node": "Busca e-mails e hashes3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca MSRs que se cadastraram há 7 dias": {
      "main": [
        [
          {
            "node": "Busca e-mails e nomes de todas as MSRs4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca e-mails e nomes de todas as MSRs4": {
      "main": [
        [
          {
            "node": "Busca e-mails e hashes4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca e-mails e hashes4": {
      "main": [
        [
          {
            "node": "Filtra apenas as que possuem primeiro nome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Concluíram a pesquisa": {
      "main": [
        [
          {
            "node": "No Operation, do nothing5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtra apenas as que possuem primeiro nome": {
      "main": [
        [
          {
            "node": "Join pelo hash",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Busca e-mails e hashes3": {
      "main": [
        [
          {
            "node": "Filtra apenas as que possuem primeiro nome1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtra apenas as que possuem primeiro nome1": {
      "main": [
        [
          {
            "node": "Join pelo hash1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Join pelo hash1": {
      "main": [
        [
          {
            "node": "Concluíram a primeira fase da pesquisa",
            "type": "main",
            "index": 0
          },
          {
            "node": "Não concluíram a primeira fase da pesquisa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Espera 5 segundos6": {
      "main": [
        [
          {
            "node": "[RESPODERAM] Envia email da segunda pesquisa para as que concluíram a primeira",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items6": {
      "main": [
        [
          {
            "node": "No Operation, do nothing7",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Espera 5 segundos6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[RESPODERAM] Envia email da segunda pesquisa para as que concluíram a primeira": {
      "main": [
        [
          {
            "node": "Loop Over Items6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[NÃO RESPODERAM] Envia email da segunda pesquisa para as que não concluíram a primeira": {
      "main": [
        [
          {
            "node": "Loop Over Items4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtém as respostas": {
      "main": [
        [
          {
            "node": "MSRs que responderam a primeira pesquisa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Concluíram a primeira fase da pesquisa": {
      "main": [
        [
          {
            "node": "Loop Over Items6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Não concluíram a primeira fase da pesquisa": {
      "main": [
        [
          {
            "node": "Loop Over Items4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Começaram mas não concluíram": {
      "main": [
        [
          {
            "node": "Loop Over Items5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Nem começaram a pesquisa1": {
      "main": [
        [
          {
            "node": "Exclui algumas MSRs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Busca MSRs que se cadastraram há 3 meses1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Inicia export das respostas da survey",
            "type": "main",
            "index": 0
          },
          {
            "node": "Busca MSRs que se cadastraram há 7 dias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2024-05-22T19:14:16.188Z",
  "id": "O17AkcfP5lNXhzLv",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "[STG] Lembretes da pesquisa da Busara",
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "https://iad1.qualtrics.com/API/v3/surveys/SV_3ltkrtQdVfXYEt0/export-responses",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "format",
              "value": "json"
            },
            {
              "name": "compress",
              "value": "false"
            },
            {
              "name": "questionIds",
              "value": "={{ [] }}"
            },
            {
              "name": "surveyMetadataIds",
              "value": "={{ ['finished'] }}"
            },
            {
              "name": "embeddedDataIds",
              "value": "={{ ['user_id'] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "213804d7-aadf-4fd7-8908-fbee7a7c12ab",
      "name": "Inicia export das respostas da survey",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1840,
        2551
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "ZSugxhtsMkxobBKb",
          "name": "Busara Qualtrics API"
        }
      }
    },
    {
      "parameters": {
        "amount": 10,
        "unit": "seconds"
      },
      "id": "a2a6f270-3998-4aa2-b281-dc38af44fac7",
      "name": "Aguarda o export terminar",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        2060,
        2551
      ],
      "webhookId": "33ac1ce3-f30c-4143-8666-efad7cf4f399"
    },
    {
      "parameters": {
        "url": "=https://iad1.qualtrics.com/API/v3/surveys/SV_3ltkrtQdVfXYEt0/export-responses/{{ $json.result.progressId }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "072b0819-ef39-40d8-b682-45a52f3be7ca",
      "name": "Verifica o status do export",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2260,
        2551
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "ZSugxhtsMkxobBKb",
          "name": "Busara Qualtrics API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "f0b7e6b7-2a50-4082-8986-3ffb4437610e",
              "leftValue": "={{ $json.result.status }}",
              "rightValue": "complete",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "b1bc334b-e99a-496b-a6b2-eb6d2fad5f57",
      "name": "Terminou de exportar as respostas?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2460,
        2551
      ]
    },
    {
      "parameters": {
        "url": "=https://iad1.qualtrics.com/API/v3/surveys/SV_3ltkrtQdVfXYEt0/export-responses/{{ $json.result.fileId }}/file",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "887618ea-482a-4142-8c70-47f16034cf42",
      "name": "Obtém as respostas",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2680,
        2531
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "ZSugxhtsMkxobBKb",
          "name": "Busara Qualtrics API"
        }
      }
    },
    {
      "parameters": {
        "content": "### Bate na API do qualtrics (ferramenta utilizada pela Busara) para descobrir quais MSRs já responderam à primeira fase da pesquisa",
        "height": 80,
        "width": 929.688750616661,
        "color": 6
      },
      "id": "56ba6e48-0c69-4558-9572-46c212e06029",
      "name": "Sticky Note2",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1840,
        2420
      ]
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "aac6b2e9-f16b-4328-b993-4c9dd52333bc",
      "name": "Espera 5 segundos4",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        4160,
        2140
      ],
      "webhookId": "f85cc393-6d23-41d1-935c-328182944fde"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "9bff06a2-7956-4862-88a8-3f54a58117a2",
      "name": "Loop Over Items4",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3920,
        2120
      ]
    },
    {
      "parameters": {},
      "id": "52477e02-b303-4427-9d02-1a122deadaa1",
      "name": "No Operation, do nothing4",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4160,
        1960
      ]
    },
    {
      "parameters": {
        "content": "### Lembrete da primeira fase da pesquisa\nDeve ser enviado 7 dias após o cadastro, apenas para as MSRs que não concluíram a pesquisa",
        "height": 93.28827475490624,
        "width": 502.0441883135077,
        "color": 6
      },
      "id": "28517bd3-08a4-447f-a90c-d887db274abf",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2160,
        3360
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "mergeByFields": {
          "values": [
            {
              "field1": "user_id",
              "field2": "user_id"
            }
          ]
        },
        "joinMode": "enrichInput2",
        "options": {
          "multipleMatches": "first"
        }
      },
      "id": "1d99a13c-f1a1-4dc8-bf47-e9554487f4db",
      "name": "Join pelo hash",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        3260,
        3480
      ]
    },
    {
      "parameters": {
        "jsCode": "const answers = $input.all()[0].json.responses;\n\nconst output = [];\n\nfor (const item of answers){\n  if(!!item.values.user_id)\n    output.push({\n      'user_id': item.values.user_id,\n      'started': 1,\n      'finished': item.values.finished,\n  \n    })\n}\n\nreturn output;"
      },
      "id": "844ccb8e-8525-4469-9d8f-fa89fd7ff779",
      "name": "MSRs que responderam a primeira pesquisa",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2920,
        2531
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.loops.so/api/v1/transactional",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n \"email\": \"{{ $json.email }}\",\n \"transactionalId\": \"clt68ffrx00811250n1tezdb7\",\n \"dataVariables\": {\n    \"name\": \"{{ $json.first_name }}\",\n   \"survey_link\": \"{{ $json.survey_link }}\"\n  }\n}",
        "options": {}
      },
      "id": "5912ee4b-ac44-4d5d-adcd-42b7c3014668",
      "name": "Envia email de lembrete para as que nem começaram1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        4700,
        4511
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "XrvtxHAVgwwJ3r6q",
          "name": "Loops API"
        }
      }
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "575ef9c9-1d49-4c34-bbff-a166ebc1a17a",
      "name": "Espera 5 segundos1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        4440,
        4511
      ],
      "webhookId": "a8070716-038d-4409-8ccb-7f32740328dc"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "fd1af9c4-f619-41c2-9327-40b40dbcd740",
      "name": "Loop Over Items2",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        4160,
        4491
      ]
    },
    {
      "parameters": {},
      "id": "1aac7234-0c10-47c9-bcb5-d959400980e3",
      "name": "No Operation, do nothing2",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4440,
        4311
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.loops.so/api/v1/transactional",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n \"email\": \"{{ $json.email }}\",\n \"transactionalId\": \"clt661u05008hr8356tdw4r77\",\n \"dataVariables\": {\n    \"name\": \"{{ $json.first_name }}\",\n   \"survey_link\": \"{{ $json.survey_link }}\"\n  }\n}",
        "options": {}
      },
      "id": "31f2a90c-f204-4722-ac94-039c38fce916",
      "name": "Envia email de lembrete para as que não finalizaram1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        4420,
        3991
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "XrvtxHAVgwwJ3r6q",
          "name": "Loops API"
        }
      }
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "3be6b24a-df54-4f8d-8978-19da89e98044",
      "name": "Espera 5 segundos5",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        4180,
        3991
      ],
      "webhookId": "df3dc129-4f48-425b-bf4d-f0af52594d6f"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "70dfb9ff-5e55-45dc-b56d-52db6c0b06f6",
      "name": "Loop Over Items5",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3920,
        3971
      ]
    },
    {
      "parameters": {},
      "id": "be20d6c3-1f14-4bac-9758-9cab8edaf649",
      "name": "No Operation, do nothing6",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4180,
        3791
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "56f3c66e-fe97-41f0-8caf-027beb7ed20a",
              "leftValue": "={{ $json.started }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "8f350115-71a3-434c-89d2-cd2fc580c486",
      "name": "Nem começaram a pesquisa1",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3660,
        4480
      ]
    },
    {
      "parameters": {},
      "id": "85c067bf-8d50-4021-80be-8c46608495d6",
      "name": "No Operation, do nothing5",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3880,
        3480
      ]
    },
    {
      "parameters": {
        "jsCode": "filter_out = ['naspimentel@hotmail.com', 'nayara.tenorio19@gmail.com', 'michellesantos2077@gmail.com', 'danielegomess00@hotmail.com', 'jaemilly2305@gmail.com', 'brunadayane2300@gmail.com', 'izaa.pnogueira@gmail.com', 'manfrealicia@gmail.com', 'larissagomes_enf@hotmail.com', 'vivianaglopes@gmail.com', 'raphaella.cds@gmail.com', 'debyeidam@gmail.com', 'deboratgs@hotmail.com', 'nat_mell@hotmail.com', 'andrezza.ag1@live.com', 'nandabpires@gmail.com', 'thayyzze@hotmail.com', 'thayyzze@hotmail.com', 'monalisalourenco@gmail.com', 'fridabarros25@gmail.com', 'marthajez2019@gmail.com', 'yasminvitoriag.deoliveira@outlook.com', 'egladisuniati@gmail.com']\n\noutput = []\n\nfor (const item of $input.all()) {\n  if(!filter_out.includes(item.json.email)) {\n    output.push(item)\n  }\n}\n\nreturn output;"
      },
      "id": "7487c871-b68f-436a-9004-001e3a4de3bc",
      "name": "Exclui algumas MSRs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3940,
        4491
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT DISTINCT msr_id\nFROM match.support_requests\nWHERE \n  DATE_TRUNC('day', created_at) = (CURRENT_DATE - INTERVAL '90 DAYS')\n  AND status != 'duplicated'",
        "options": {}
      },
      "id": "035f7ae0-0a37-41e3-a9d3-73a137d0b439",
      "name": "Busca MSRs que se cadastraram há 3 meses1",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        2040,
        1600
      ],
      "credentials": {
        "postgres": {
          "id": "c5mNsjWNXx3mw1Fh",
          "name": "[PROD] Mapa"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    '{{ $json.first_name }}' first_name,\n    msr_email AS email,\n    hash AS user_id,\n    CONCAT('https://busara.iad1.qualtrics.com/jfe/form/SV_bfpbu1KfIDj34Q6?user_id=', hash) AS survey_link\nFROM match.busara_hashes\nwhere msr_email = '{{ $json.email }}'",
        "options": {}
      },
      "id": "8646b4f6-1cf0-46b7-85dd-a1e20dacb126",
      "name": "Busca e-mails e hashes3",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        2460,
        1600
      ],
      "credentials": {
        "postgres": {
          "id": "c5mNsjWNXx3mw1Fh",
          "name": "[PROD] Mapa"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  user_id AS msr_id, \n  email,\n  SPLIT_PART(name, ' ', 1) AS first_name\nFROM solidarity_users\nWHERE organization_id = 360273031591\nAND user_id = {{ $json.msr_id }}",
        "options": {}
      },
      "id": "f5c136d5-445d-473d-8fa2-a7a2f65c5d59",
      "name": "Busca e-mails e nomes de todas as MSRs2",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        2260,
        1600
      ],
      "credentials": {
        "postgres": {
          "id": "GPnWI2OL5IjBv3zm",
          "name": "[PROD] Bonde"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  user_id AS msr_id, \n  email,\n  SPLIT_PART(name, ' ', 1) AS first_name\nFROM solidarity_users\nWHERE organization_id = 360273031591\nAND user_id = {{ $json.msr_id }}",
        "options": {}
      },
      "id": "d6670b9b-ffd4-465d-990d-513e423ec8d7",
      "name": "Busca e-mails e nomes de todas as MSRs4",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        2440,
        3500
      ],
      "credentials": {
        "postgres": {
          "id": "GPnWI2OL5IjBv3zm",
          "name": "[PROD] Bonde"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  DISTINCT msr_id  \nFROM match.support_requests\nWHERE \n  DATE_TRUNC('day', created_at) = (CURRENT_DATE - INTERVAL '7 DAYS')\n  AND status != 'duplicated'",
        "options": {}
      },
      "id": "9c99df16-277e-444e-ad0d-ccbbc6530cd0",
      "name": "Busca MSRs que se cadastraram há 7 dias",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        2160,
        3500
      ],
      "credentials": {
        "postgres": {
          "id": "c5mNsjWNXx3mw1Fh",
          "name": "[PROD] Mapa"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    '{{ $json.first_name }}' first_name,\n    msr_email AS email,\n    hash AS user_id,\n    CONCAT('https://busara.iad1.qualtrics.com/jfe/form/SV_bfpbu1KfIDj34Q6?user_id=', hash) AS survey_link\nFROM match.busara_hashes\nwhere msr_email = '{{ $json.email }}'",
        "options": {}
      },
      "id": "2623aab5-f1a6-45f5-bc90-52dbd620c916",
      "name": "Busca e-mails e hashes4",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        2680,
        3500
      ],
      "credentials": {
        "postgres": {
          "id": "c5mNsjWNXx3mw1Fh",
          "name": "[PROD] Mapa"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "56f3c66e-fe97-41f0-8caf-027beb7ed20a",
              "leftValue": "={{ $json.started }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            },
            {
              "id": "07ce7ea8-8855-4a27-82fc-8f5655029354",
              "leftValue": "={{ $json.finished }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "755ad5f4-ae7e-4805-aaf3-6e068a42ea49",
      "name": "Concluíram a pesquisa",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3660,
        3480
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "56f3c66e-fe97-41f0-8caf-027beb7ed20a",
              "leftValue": "={{ $json.started }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            },
            {
              "id": "07ce7ea8-8855-4a27-82fc-8f5655029354",
              "leftValue": "={{ $json.finished }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "36746e1d-6948-4afc-a15c-7456a9d7b4e5",
      "name": "Começaram mas não concluíram",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3660,
        3971
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "22317f1c-3539-487f-b323-8bcc7a31ea92",
              "leftValue": "={{ $json.first_name }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "c82d1c29-40e1-48f0-bd01-39ddb195a207",
      "name": "Filtra apenas as que possuem primeiro nome",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        2900,
        3500
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "22317f1c-3539-487f-b323-8bcc7a31ea92",
              "leftValue": "={{ $json.first_name }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9218eb69-3a41-48eb-bffd-2ba85bc30315",
      "name": "Filtra apenas as que possuem primeiro nome1",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        2720,
        1600
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "mergeByFields": {
          "values": [
            {
              "field1": "user_id",
              "field2": "user_id"
            }
          ]
        },
        "joinMode": "enrichInput1",
        "options": {
          "multipleMatches": "first"
        }
      },
      "id": "21a2dafd-8b68-4a58-a332-9739ccdc1be7",
      "name": "Join pelo hash1",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        3200,
        1620
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "56f3c66e-fe97-41f0-8caf-027beb7ed20a",
              "leftValue": "={{ $json.started }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            },
            {
              "id": "07ce7ea8-8855-4a27-82fc-8f5655029354",
              "leftValue": "={{ $json.finished }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "3cb3aa17-ae57-44d0-966d-30653f19b46f",
      "name": "Concluíram a primeira fase da pesquisa",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3560,
        1620
      ]
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "da981234-5212-4d45-8d73-68744333ea82",
      "name": "Espera 5 segundos6",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        4220,
        1640
      ],
      "webhookId": "a9966c2b-0fcf-409c-a93e-388faff79b3c"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "4c27ecad-6626-4157-bd90-8d1783111d14",
      "name": "Loop Over Items6",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3960,
        1620
      ]
    },
    {
      "parameters": {},
      "id": "88660280-0d31-43c4-a33b-e47992f4ab40",
      "name": "No Operation, do nothing7",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4220,
        1440
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "56f3c66e-fe97-41f0-8caf-027beb7ed20a",
              "leftValue": "={{ $json.finished }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "notExists",
                "singleValue": true
              }
            },
            {
              "id": "07ce7ea8-8855-4a27-82fc-8f5655029354",
              "leftValue": "={{ $json.finished }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "0cf7f1b2-17b5-40cf-a323-aeaa00250a3e",
      "name": "Não concluíram a primeira fase da pesquisa",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3600,
        2120
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.loops.so/api/v1/transactional",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n \"email\": \"{{ $json.email }}\",\n \"transactionalId\": \"clvdteefr01569iklhmx72s8r\",\n \"dataVariables\": {\n    \"name\": \"{{ $json.first_name }}\",\n   \"survey_link\": \"{{ $json.survey_link }}&has_completed_baseline=true\"\n  }\n}",
        "options": {}
      },
      "id": "1b0922a6-c75d-44d4-884a-1f2d9f68b003",
      "name": "[RESPODERAM] Envia email da segunda pesquisa para as que concluíram a primeira",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        4460,
        1640
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "XrvtxHAVgwwJ3r6q",
          "name": "Loops API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.loops.so/api/v1/transactional",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n \"email\": \"{{ $json.email }}\",\n \"transactionalId\": \"clvldt03j01dk14cjzi6g5u7l\",\n \"dataVariables\": {\n    \"name\": \"{{ $json.first_name }}\",\n   \"survey_link\": \"{{ $json.survey_link }}&has_completed_baseline=false\"\n  }\n}",
        "options": {}
      },
      "id": "997be21f-2c4f-4caa-b00f-80a13a9bce6a",
      "name": "[NÃO RESPODERAM] Envia email da segunda pesquisa para as que não concluíram a primeira",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        4360,
        2140
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "XrvtxHAVgwwJ3r6q",
          "name": "Loops API"
        }
      }
    },
    {
      "parameters": {
        "content": "### Envia a segunda fase da pesquisa\nDeve ser enviado 90 dias após o cadastro para todas as MSRs",
        "height": 93.28827475490624,
        "width": 502.0441883135077,
        "color": 6
      },
      "id": "685033a7-8a50-4949-9c4c-f9fda3a334cd",
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2040,
        1440
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 9
            }
          ]
        }
      },
      "id": "778af3d6-cef8-406b-937b-756ac16f94ed",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        1020,
        2560
      ]
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "HYstwqyTrzYsvJ2P"
  },
  "staticData": {
    "node:Schedule Trigger": {
      "recurrencyRules": []
    },
    "node:Schedule Trigger1": {
      "recurrencyRules": []
    }
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2024-05-22T20:31:31.000Z",
  "versionId": "915f7f80-6167-4e8b-a2a0-68f6cf8b92f9"
}