{
  "active": false,
  "connections": {
    "Busca as coordenadas do endereço1": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Checks if we need to update support_request": {
      "main": [
        [
          {
            "node": "Should update?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should update?": {
      "main": [
        [
          {
            "node": "Limit",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limit": {
      "main": [
        [
          {
            "node": "Busca as coordenadas do endereço1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Updates support_request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook MSR": {
      "main": [
        [
          {
            "node": "Normalize Zendesk input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Zendesk input": {
      "main": [
        [
          {
            "node": "Checks if we need to update support_request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Volunteer": {
      "main": [
        [
          {
            "node": "Normalize Zendesk input1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Zendesk input1": {
      "main": [
        [
          {
            "node": "Checks if we need to update support_request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca as coordenadas do endereço2": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Updates volunteer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Checks if we need to update support_request1": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Busca as coordenadas do endereço2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Update volunteer_availability",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2024-02-26T19:30:17.425Z",
  "id": "sDNi2TJAPi3UQO8U",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "[STG]  Integração Zendesk/BD",
  "nodes": [
    {
      "parameters": {
        "url": "=https://novoqueroacolher.staging.bonde.org/address/",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "city",
              "value": "={{ $json.new_city }}"
            },
            {
              "name": "state",
              "value": "={{ $json.new_state }}"
            },
            {
              "name": "zipcode",
              "value": "={{ $json.zipcode }}"
            }
          ]
        },
        "options": {}
      },
      "id": "8582bde8-a9c0-4a55-8712-e77f1300ec19",
      "name": "Busca as coordenadas do endereço1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        640,
        -60
      ]
    },
    {
      "parameters": {},
      "id": "42f634cf-ecd7-4c73-b1d4-3d0f6318d82a",
      "name": "No Operation, do nothing1",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        420,
        400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  support_request_id,\n  '{{ $json.body.city }}' AS new_city,\n  '{{ $json.body.state }}' AS new_state,\n  '{{ $json.body.zipcode }}' AS zipcode,\n  CASE WHEN city != '{{ $json.body.city }}' OR state != '{{ $json.body.state }}' THEN TRUE ELSE FALSE END AS should_update\nFROM match.support_requests\nWHERE msr_id = {{ $json.body.msr_id }}",
        "options": {}
      },
      "id": "e34a4c81-a8a0-484b-8cce-1f2acc62c7f4",
      "name": "Checks if we need to update support_request",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        20,
        140
      ],
      "credentials": {
        "postgres": {
          "id": "lveNjRL3anzREWd8",
          "name": "[STG] Mapa"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "9bbb07e8-f753-4190-b6a4-ca7c6eee7875",
              "leftValue": "={{ $json.should_update }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "e6468469-ef55-46f6-af0e-105a2405484b",
      "name": "Should update?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        240,
        140
      ]
    },
    {
      "parameters": {},
      "id": "45b7f25c-16c0-4619-b38c-e9d457eab266",
      "name": "Limit",
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        420,
        -60
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "a4818087-e2ec-4656-a4db-0b5f39ce11b6",
      "name": "Merge2",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        840,
        100
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "update-msr-info",
        "options": {}
      },
      "id": "1a43851b-1c19-4d9d-9156-26298ba7978b",
      "name": "Webhook MSR",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        -420,
        140
      ],
      "webhookId": "06308513-32bf-4667-8c8c-647e9dcd4e5f"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE match.support_requests\nSET city = '{{ $json.new_city }}', state = '{{ $json.new_state }}', lat = {{ $json.coordinates.lat }}, lng = {{ $json.coordinates.lng }}, updated_at = NOW()\nWHERE support_request_id = {{ $json.support_request_id }}",
        "options": {}
      },
      "id": "c033f74f-d901-4cb1-ae89-ce92d678ffaf",
      "name": "Updates support_request",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        1060,
        100
      ],
      "credentials": {
        "postgres": {
          "id": "lveNjRL3anzREWd8",
          "name": "[STG] Mapa"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "update-volunteer-info",
        "options": {}
      },
      "id": "7a57eee9-bd44-488a-b99e-f1fefa9c50fc",
      "name": "Webhook Volunteer",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        -440,
        820
      ],
      "webhookId": "06308513-32bf-4667-8c8c-647e9dcd4e5f"
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.body.city = item.json.body.city.normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\")\n    .replace(\"'\", \" \")\n    .replace(/ *\\([^)]*\\) */g, \"\").toUpperCase();\n  item.json.body.zipcode = item.json.body.zipcode.replace(\"-\", \"\")\n}\n\nreturn $input.all();"
      },
      "id": "ddc5e665-b8c0-40d8-aa93-0cb06346a157",
      "name": "Normalize Zendesk input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -200,
        140
      ]
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.body.city = item.json.body.city.normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\")\n    .replace(\"'\", \" \")\n    .replace(/ *\\([^)]*\\) */g, \"\").toUpperCase();\n  item.json.body.zipcode = item.json.body.zipcode.replaceAll(\"-\", \"\"),\n    item.json.body.phone = item.json.body.phone.replaceAll(\" \", \"\").replaceAll(\"(\", \"\").replaceAll(\")\", \"\").replaceAll(\"-\", \"\")\n}\n\nreturn $input.all();"
      },
      "id": "4821aff8-673a-4108-8d42-75352126b5cf",
      "name": "Normalize Zendesk input1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -200,
        820
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  id AS volunteer_id,\n  '{{ $json.body.city }}' AS new_city,\n  '{{ $json.body.state }}' AS new_state,\n  '{{ $json.body.zipcode }}' AS new_zipcode,\n  '{{ $json.body.first_name }}' AS new_first_name,\n  '{{ $json.body.availability }}' AS new_availability,\n  '{{ $json.body.phone }}' AS new_phone,\n  '{{ $json.body.register_number }}' AS new_register_number,\n  CASE \n    WHEN \n      city != '{{ $json.body.city }}' OR \n      state != '{{ $json.body.state }}' OR \n      zipcode != '{{ $json.body.zipcode }}'\n    THEN TRUE \n    ELSE FALSE \n  END AS should_update_geolocation,\n  CASE WHEN availability != '{{ $json.body.availability }}' THEN TRUE ELSE FALSE END AS should_update_availability,\n  CASE \n    WHEN \n      first_name != '{{ $json.body.first_name }}' OR \n      phone != '{{ $json.body.phone }}' OR \n      register_number != '{{ $json.body.register_number }}' \n    THEN TRUE \n    ELSE FALSE \n  END AS should_update_personal\nFROM public.volunteers\nWHERE zendesk_user_id = {{ $json.body.volunteer_user_id }}",
        "options": {}
      },
      "id": "dca0f90d-e87f-4b0b-ad67-c45b25283083",
      "name": "Checks if we need to update support_request1",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        60,
        820
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "lveNjRL3anzREWd8",
          "name": "[STG] Mapa"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://novoqueroacolher.staging.bonde.org/address/",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "city",
              "value": "={{ $json.new_city }}"
            },
            {
              "name": "state",
              "value": "={{ $json.new_state }}"
            },
            {
              "name": "zipcode",
              "value": "={{ $json.new_zipcode }}"
            }
          ]
        },
        "options": {}
      },
      "id": "1a23cb8d-5898-45c8-94ec-586e8571546e",
      "name": "Busca as coordenadas do endereço2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        600,
        640
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "8ec81839-3e2a-4d27-abc6-ed6dd35ccdbb",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        980,
        760
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE volunteers\nSET \n  city = '{{ $json.new_city }}', \n  state = '{{ $json.new_state }}', \n  zipcode = '{{ $json.new_zipcode }}',\n  latitude = {{ $json.coordinates.lat }}, \n  longitude = {{ $json.coordinates.lng }}, \n  first_name = '{{ $json.new_first_name }}',\n  availability = '{{ $json.new_availability }}',\n  phone = '{{ $json.new_phone }}',\n  register_number = '{{ $json.new_register_number }}',\n  updated_at = NOW()\nWHERE id = {{ $json.volunteer_id }}",
        "options": {}
      },
      "id": "952cf2df-69b7-4c31-b1b1-cc011740336d",
      "name": "Updates volunteer",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        1180,
        760
      ],
      "credentials": {
        "postgres": {
          "id": "lveNjRL3anzREWd8",
          "name": "[STG] Mapa"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.should_update_geolocation }}",
                    "rightValue": "{{ true }}",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "geolocation"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "1206305f-a715-4cb0-990a-d942246a7212",
                    "leftValue": "={{ $json.should_update_personal }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "personal"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "26fd6c46-a2eb-4299-a425-e7978d0102fd",
                    "leftValue": "={{ $json.should_update_availability }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "availability"
            }
          ]
        },
        "options": {
          "allMatchingOutputs": true
        }
      },
      "id": "b518578a-818b-405a-afa4-d7f76ec9d59f",
      "name": "Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        280,
        820
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE public.volunteer_availability\nSET max_matches = {{ $json.new_availability }}, updated_at = NOW()\nWHERE volunteer_id = {{ $json.volunteer_id }}",
        "options": {}
      },
      "id": "ec0f39f8-aff8-48b4-aa23-6c4a3066862c",
      "name": "Update volunteer_availability",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [
        580,
        1020
      ],
      "credentials": {
        "postgres": {
          "id": "lveNjRL3anzREWd8",
          "name": "[STG] Mapa"
        }
      }
    }
  ],
  "pinData": {
    "Webhook Volunteer": [
      {
        "json": {
          "headers": {
            "host": "mapadoacolhimento.app.n8n.cloud",
            "user-agent": "Zendesk Webhook",
            "content-length": "206",
            "accept-encoding": "gzip",
            "authorization": "Basic ZGV2QG1hcGEub3JnLmJyL3Rva2VuOkxWMHJoR2hxYzd1UTB2OGwzbTFtUFhwdmVZVFNMWG93UU4xbEJLZFk=",
            "content-type": "application/json; charset=utf-8",
            "traceparent": "00-000000000000000038f170c384542dfd-38f170c384542dfd-00",
            "tracestate": "dd=s:-1",
            "x-forwarded-for": "216.198.2.146",
            "x-forwarded-host": "mapadoacolhimento.app.n8n.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "traefik-f7d8fb88c-x5dxb",
            "x-real-ip": "216.198.2.146",
            "x-request-id": "6b88f9d6-5514-4a70-bc0c-103310d86794",
            "x-zendesk-account-id": "9040899",
            "x-zendesk-webhook-id": "01HSGXS4E94S3BH8DFMQKPAVDJ",
            "x-zendesk-webhook-invocation-id": "01HSH5WFT3QGMKVJ8KMXP8FXF0",
            "x-zendesk-webhook-signature": "vi0SpiaywFdDLF7JA5UZ4eoEKsAbmCuKT9hv2x1j0jI=",
            "x-zendesk-webhook-signature-timestamp": "2024-03-21T18:55:27Z"
          },
          "params": {},
          "query": {},
          "body": {
            "volunteer_user_id": "423092711812",
            "city": "Belo Horizonte",
            "state": "MG",
            "first_name": "Adev",
            "availability": "1",
            "zipcode": "",
            "phone": "(31) 9 9910-7452",
            "register_number": "17643999"
          }
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2024-03-21T19:35:35.000Z",
  "versionId": "534d30fe-8a27-4053-8903-5b2696ff721c"
}